version: '2'
services:

  backend:
    build: ./api
    command: ./entrypoint.sh
    environment:
      - NCSA=true
      - CELERY_BROKER=amqp://dri:adminadmin@rabbit:5672
    volumes:
      - ./api:/app
      - ./archive:/archive
      - ./log/backend:/log
    depends_on:
      - rabbit
    env_file:
      - .env


  rabbit:
      image: rabbitmq:3-management
      hostname: rabbit_dri
      environment:
          - RABBITMQ_DEFAULT_USER=dri
          - RABBITMQ_DEFAULT_PASS=adminadmin

  iipserver:
    image: linea/iipserver:latest
    environment:
      - LOGFILE=/log/iipsrv.log
      - VERBOSITY=10
      - FILESYSTEM_PREFIX=/images/
      - MAX_IMAGE_CACHE_SIZE=10
      - MAX_CVT=3000
      - JPEG_QUALITY=90
      - CORS=*
    command: ./start_fcgi.sh
    volumes:
      - ./log/iipserver:/log
      - ./archive/images:/images

  daiquiri:
    build: ./daiquiri
    working_dir: /daiquiri_app
    command: ./entrypoint.sh
    env_file:
      - ./daiquiri/.env
    volumes:
      - ./daiquiri:/daiquiri_app
      # Diretório de arquivos estaticos do Django deve ser compartilhado com o Ngnix.
      - /archive/daiquiri_static:/daiquiri_app/static_root
      - /archive/files:/daiquiri_app/files
      - /archive/download:/daiquiri_app/download
      - /archive/upload:/daiquiri_app/upload
      # Diretório de logs do Daiquiri
      - ./log/daiquiri:/log
    depends_on:
      - database
      - rabbit

  nginx:
    build: ./frontend
    ports:
      - 80:8080
      - 443:4443
    volumes:
      # Arquivo de Configuração do Nginx
      - ./frontend/nginx-proxy.conf:/etc/nginx/conf.d/default.conf
      # Certbot SSL
      - ./archive/certbot/conf:/etc/letsencrypt
      - ./archive/certbot/www:/var/www/certbot
      # Diretorio de Logs
      - ./log/nginx:/var/log/nginx
      # Diretório de dados da aplicação
      - ./archive:/var/www/data
      # Google Analytics Script
      - ./google-analytics.js:/var/www/ga/google-analytics.js
    depends_on:
      - backend
      - iipserver
      - rabbit
      - daiquiri
