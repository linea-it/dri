L.Projection.WCS=L.Class.extend({bounds:L.bounds([-0.5,-0.5],[0.5,0.5]),project:function(b){var a=this._raDecToPhiTheta(this.celsysflag?this.eqToCelsys(b):b);a.lat=this._thetaToR(a.lat);return this._redToPix(this._phiRToRed(a))},unproject:function(a){var b=this._redToPhiR(this._pixToRed(a));b.lat=this._rToTheta(b.lat);var c=this._phiThetaToRADec(b);if(c.lng<-180){c.lng+=360}return this.celsysflag?this.celsysToEq(c):c},_natpole:function(){var c=Math.PI/180,a=this.projparam,b=L.latLng(90,180);if(a.natrval.lat===90){if(a.natpole.lng===999){b.lng=180}b.lat=a.crval.lat}else{if(a.natpole.lng===999){b.lng=(a.crval.lat<a.natrval.lat)?180:0}}return b},_cpole:function(){var c=Math.PI/180,n=this.projparam,e=n.natpole.lng-n.natrval.lng,m=Math.cos(e*c),k=Math.sin(e*c),a=Math.cos(n.natrval.lat*c),j=Math.sin(n.natrval.lat*c),l=Math.cos(n.crval.lat*c),b=Math.sin(n.crval.lat*c),f=Math.atan2(j,a*m)/c,i=Math.acos(b/Math.sqrt(1-a*a*k*k))/c,h=f+i,g=f-i;if(h<-180){h+=360}else{if(h>180){h-=360}}if(g<-180){g+=360}else{if(g>180){g-=360}}if(h>90){f=g}else{if(g<-90){f=h}else{f=(Math.abs(h-n.natpole.lat)<Math.abs(g-n.natpole.lat))?h:g}}var d=Math.abs(n.crval.lat)===90?n.crval.lng:(f===90?n.crval.lng+n.natpole.lng-n.natrval.lng-180:(f===-90?n.crval.lng-n.natpole.lng+n.natrval.lng:n.crval.lng-Math.atan2(k*a/l,(j-Math.sin(f*c)*b)/(Math.cos(f*c)*l))/c));return L.latLng(f,d)},_phiThetaToRADec:function(e){var l=this.projparam,a=Math.PI/180,g=180/Math.PI,j=e.lat*a,f=Math.cos(j),k=Math.sin(j),c=l.cpole.lat*a,h=Math.cos(c),b=Math.sin(c),d=(e.lng-l.natpole.lng)*a,i=Math.cos(d),m=k*b+f*h*i;if(m>1){m=1}else{if(m<-1){m=-1}}return L.latLng(Math.asin(m)*g,l.cpole.lng+Math.atan2(-f*Math.sin(d),k*h-f*b*i)*g)},_raDecToPhiTheta:function(b){var m=this.projparam,a=Math.PI/180,j=180/Math.PI,p=(b.lng-m.cpole.lng)*a,g=Math.cos(p),o=Math.sin(p),i=b.lat*a,c=Math.cos(i),h=Math.sin(i),f=m.cpole.lat*a,l=Math.cos(f),e=Math.sin(f),n=h*e+c*l*g,k=L.latLng(Math.asin(n>1?1:(n<-1?-1:n))*j,m.natpole.lng+Math.atan2(-c*o,h*l-c*e*g)*j);if(k.lng>180){k.lng-=360}else{if(k.lng<-180){k.lng+=360}}return k},_pixToRed:function(b){var a=this.projparam,d=a.cd,c=b.subtract(a.crpix);return L.point(c.x*d[0][0]+c.y*d[0][1],c.x*d[1][0]+c.y*d[1][1])},_redToPix:function(c){var a=this.projparam,b=a.cdinv;return L.point(c.x*b[0][0]+c.y*b[0][1],c.x*b[1][0]+c.y*b[1][1]).add(a.crpix)},_invertCD:function(b){var a=1/(b[0][0]*b[1][1]-b[0][1]*b[1][0]);return[[b[1][1]*a,-b[0][1]*a],[-b[1][0]*a,b[0][0]*a]]}});L.Projection.WCS.PIX=L.Projection.WCS.extend({code:"PIX",_paramInit:function(a){this.projparam=a;a.cdinv=this._invertCD(a.cd);a.cpole=a.crval;this.bounds=L.bounds([0.5,this.projparam.naxis.y-0.5],[this.projparam.naxis.x-0.5,0.5])},project:function(a){return L.point(a.lng,a.lat)},unproject:function(a){return L.latLng(a.y,a.x)}});L.Projection.WCS.zenithal=L.Projection.WCS.extend({_paramInit:function(a){this.projparam=a;a.cdinv=this._invertCD(a.cd);a.natrval=L.latLng(90,0);a.natpole=this._natpole();a.cpole=this._cpole()},_redToPhiR:function(a){return L.latLng(Math.sqrt(a.x*a.x+a.y*a.y),Math.atan2(a.x,-a.y)*180/Math.PI)},_phiRToRed:function(a){var b=Math.PI/180,c=a.lng*b;return new L.Point(a.lat*Math.sin(c),-a.lat*Math.cos(c))}});L.Projection.WCS.TAN=L.Projection.WCS.zenithal.extend({code:"TAN",_rToTheta:function(a){return Math.atan2(180,Math.PI*a)*180/Math.PI},_thetaToR:function(a){return Math.tan((90-a)*Math.PI/180)*180/Math.PI}});L.Projection.WCS.ZEA=L.Projection.WCS.zenithal.extend({code:"ZEA",_rToTheta:function(b){var a=b*Math.PI/360;if(Math.abs(a)<1){return 90-2*Math.asin(a)*180/Math.PI}else{return 90}},_thetaToR:function(a){return Math.sin((90-a)*Math.PI/360)*360/Math.PI}});L.Projection.WCS.cylindrical=L.Projection.WCS.extend({_paramInit:function(a){var b=Math.PI/180;this.projparam=a;a.cdinv=this._invertCD(a.cd);a.lambda=a.pv[1][1];if(a.lambda===0){a.lambda=1}a.natrval=L.latLng(0,0);a.natpole=this._natpole();a.cpole=this._cpole()},_rToTheta:function(a){return a},_thetaToR:function(a){return a}});L.Projection.WCS.CAR=L.Projection.WCS.cylindrical.extend({_redToPhiR:function(a){return L.latLng(a.y,a.x)},_phiRToRed:function(a){return L.point(a.lng,a.lat)}});L.Projection.WCS.CEA=L.Projection.WCS.cylindrical.extend({_redToPhiR:function(c){var b=Math.PI/180,a=c.y*this.projparam.lambda*b;return L.latLng(a>-1?(a<1?Math.asin(a)/b:90):-90,c.x)},_phiRToRed:function(a){var b=Math.PI/180;return L.point(a.lng,Math.sin(a.lat*b)/(this.projparam.lambda*b))}});L.Projection.WCS.conical=L.Projection.WCS.extend({_redToPhiR:function(e){var c=Math.PI/180,a=this.projparam,b=a.y0-e.y,d=a.sthetaA*Math.sqrt(e.x*e.x+b*b);return L.latLng(d,Math.atan2(e.x/d,b/d)/a.c/c)},_phiRToRed:function(a){var b=Math.PI/180,c=this.projparam.c*a.lng*b;return L.point(a.lat*Math.sin(c),-a.lat*Math.cos(c)+this.projparam.y0)}});L.Projection.WCS.COE=L.Projection.WCS.conical.extend({_paramInit:function(a){var d=Math.PI/180;this.projparam=a;a.cdinv=this._invertCD(a.cd);a.thetaA=a.pv[1][1];a.eta=a.pv[1][2];a.sthetaA=a.thetaA>=0?1:-1;var f=a.thetaA-a.eta,e=a.thetaA+a.eta,c=Math.sin(f*d),b=Math.sin(e*d);a.gamma=c+b;a.s1s2p1=c*b+1;a.c=a.gamma/2;a.y0=2/a.gamma*Math.sqrt(a.s1s2p1-a.gamma*Math.sin(a.thetaA*d))/d;a.natrval=L.latLng(a.thetaA,0);a.natpole=this._natpole();a.cpole=this._cpole()},_rToTheta:function(d){var c=Math.PI/180,b=this.projparam.gamma,a=this.projparam.s1s2p1/b-b*d*d*c*c/4;if(a<-1){a=-1}else{if(a>1){a=1}}return Math.asin(a)/c},_thetaToR:function(b){var c=Math.PI/180,a=this.projparam.gamma;return 2/a*Math.sqrt(this.projparam.s1s2p1-a*Math.sin(b*c))/c}});L.CRS.WCS=L.extend({},L.CRS,{code:"WCS",options:{nzoom:9,tileSize:[256,256],nativeCelsys:false},defaultparam:{ctype:{x:"PIXEL",y:"PIXEL"},naxis:[256,256],crpix:[129,129],crval:[0,0],cd:[[1,0],[0,1]],natrval:[90,0],natpole:[90,999],pv:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},initialize:function(c,a){a=L.setOptions(this,a);var b=this.defaultparam;this.tileSize=L.point(a.tileSize);this.nzoom=a.nzoom;this.ctype={x:b.ctype.x,y:b.ctype.y};this.naxis=L.point(b.naxis,true);this.projparam=new this._paramInit(b);if(c){this._readWCS(c)}this._paramInit(a,this.projparam);switch(this.ctype.x.substr(5,3)){case"ZEA":this.projection=new L.Projection.WCS.ZEA();this.pixelFlag=false;this.infinite=true;break;case"TAN":this.projection=new L.Projection.WCS.TAN();this.pixelFlag=false;this.infinite=true;break;case"CAR":this.projection=new L.Projection.WCS.CAR();this.pixelFlag=false;this.infinite=true;break;case"CEA":this.projection=new L.Projection.WCS.CEA();this.pixelFlag=false;this.infinite=true;break;case"COE":this.projection=new L.Projection.WCS.COE();this.pixelFlag=false;this.infinite=true;break;default:this.projection=new L.Projection.WCS.PIX();this.pixelFlag=true;this.infinite=false;if(!this.options.crval){this.projparam.crval=L.latLng((this.naxis.y+1)/2,(this.naxis.x+1)/2)}this.wrapLng=[0.5,this.naxis.x-0.5];this.wrapLat=[this.naxis.y-0.5,0.5];break}if(!this.pixelFlag){switch(this.ctype.x.substr(0,1)){case"G":this.celsyscode="galactic";break;case"E":this.celsyscode="ecliptic";break;case"S":this.celsyscode="supergalactic";break;default:this.celsyscode="equatorial";break}if(this.celsyscode!=="equatorial"){this.projparam.celsysmat=this._celsysmatInit(this.celsyscode);this.projection.celsysToEq=this.celsysToEq;this.projection.eqToCelsys=this.eqToCelsys;this.forceNativeCelsys=(this.options.nativeCelsys===true);this.projection.celsysflag=!this.forceNativeCelsys}}this.transformation=new L.Transformation(1,-0.5,-1,this.naxis.y+0.5);this.projection._paramInit(this.projparam);this.code+=":"+this.projection.code},celsysToEq:function(f){var c=this.projparam.celsysmat,e=Math.PI/180,i=180/Math.PI,d=f.lng*e-c[1],b=f.lat*e,a=Math.sin(b),h=Math.cos(b)*c[2],g=a*c[3]-h*Math.cos(d);return L.latLng(Math.asin(g)*i,((Math.atan2(h*Math.sin(d),a-g*c[3])+c[0])*i+360)%360)},eqToCelsys:function(i){var e=this.projparam.celsysmat,f=Math.PI/180,b=180/Math.PI,c=i.lng*f-e[0],h=Math.sin(i.lat*f),d=Math.cos(i.lat*f)*e[2],g=h*e[3]+d*Math.cos(c);return L.latLng(Math.asin(g)*b,((Math.atan2(d*Math.sin(c),g*e[3]-h)+e[1])*b+360)%360)},scale:function(a){return Math.pow(2,a-this.nzoom+1)},zoom:function(a){return Math.log(a)/Math.LN2+this.nzoom-1},rawPixelScale:function(f){var e=this.projection.project(f),b=this.projection.unproject(e.add([10,0])),a=this.projection.unproject(e.add([0,10])),d=b.lng-f.lng,c=a.lng-f.lng;if(d>180){d-=360}else{if(d<-180){d+=360}}if(c>180){c-=360}else{if(c<-180){c+=360}}return 0.1*Math.sqrt(Math.abs((d*(a.lat-f.lat)-c*(b.lat-f.lat)))*Math.cos(f.lat*Math.PI/180))},pixelScale:function(a,b){return this.rawPixelScale(b)/this.scale(a)},fovToZoom:function(c,a,e){var d=this.rawPixelScale(e),b=c.getSize();if(a<d){a=d}d*=Math.sqrt(b.x*b.x+b.y*b.y);return a>0?this.zoom(d/a):this.nzoom-1},zoomToFov:function(c,b,f){var a=c.getSize(),d=this.rawPixelScale(f)*Math.sqrt(a.x*a.x+a.y*a.y),e=this.scale(b);return e>0?d/e:d},distance:function(c,g){var b=Math.PI/180,f=c.lat*b,e=g.lat*b,d=Math.sin(f)*Math.sin(e)+Math.cos(f)*Math.cos(e)*Math.cos((g.lng-c.lng)*b);return 180/Math.PI*Math.acos(Math.min(d,1))},parseCoords:function(c,b){var a;if(b){a=/J\s(\d+\.?\d*)\s*,?\s*\+?(-?\d+\.?\d*)/g.exec(c)}else{a=/(-?\d+\.?\d*)\s*,\s*\+?(-?\d+\.?\d*)/g.exec(c)}if(a&&a.length>=3){var d=L.latLng(Number(a[2]),Number(a[1]));if(this.forceNativeCelsys){d=this.eqToCelsys(d)}return d}else{return undefined}},_paramInit:function(a,b){if(!b){b=this}if(a.naxis){b.naxis=L.point(a.naxis)}if(a.crval){b.crval=b.cpole=L.latLng(a.crval)}if(a.crpix){b.crpix=L.point(a.crpix)}if(a.cd){b.cd=[[a.cd[0][0],a.cd[0][1]],[a.cd[1][0],a.cd[1][1]]]}if(a.natrval){b.natrval=L.latLng(a.natrval)}if(a.natpole){b.natpole=L.latLng(a.natpole)}if(a.pv){b.pv=[];b.pv[0]=a.pv[0].slice();b.pv[1]=a.pv[1].slice()}},_celsysmatInit:function(e){var c=Math.PI/180,d,b,a=[];switch(e){case"galactic":d=L.latLng(-28.93617242,266.40499625);b=L.latLng(27.1282512,192.85948123);break;case"ecliptic":d=L.latLng(0,0);b=L.latLng(66.99111111,273.85261111);break;case"supergalactic":d=L.latLng(59.52315,42.29235);b=L.latLng(15.7048,283.7514);break;default:d=L.latLng(0,0);b=L.latLng(0,0);break}a[0]=b.lng*c;a[1]=Math.asin(Math.cos(d.lat*c)*Math.sin((b.lng-d.lng)*c));a[2]=Math.cos(b.lat*c);a[3]=Math.sin(b.lat*c);return a},_readWCS:function(g){var e=L.IIPUtils.readFITSKey,a=this.projparam,b;if((b=e("CTYPE1",g))){this.ctype.x=b}if((b=e("CTYPE2",g))){this.ctype.y=b}if((b=e("NAXIS1",g))){a.naxis.x=this.naxis.x=parseInt(b,10)}if((b=e("NAXIS2",g))){a.naxis.y=this.naxis.y=parseInt(b,10)}if((b=e("CRPIX1",g))){a.crpix.x=parseFloat(b,10)}if((b=e("CRPIX2",g))){a.crpix.y=parseFloat(b,10)}if((b=e("CRVAL1",g))){a.crval.lng=parseFloat(b,10)}if((b=e("CRVAL2",g))){a.crval.lat=parseFloat(b,10)}if((b=e("LONPOLE",g))){a.natpole.lng=parseFloat(b,10)}if((b=e("LATPOLE",g))){a.natpol.lat=parseFloat(b,10)}if((b=e("CD1_1",g))){a.cd[0][0]=parseFloat(b,10)}if((b=e("CD1_2",g))){a.cd[0][1]=parseFloat(b,10)}if((b=e("CD2_1",g))){a.cd[1][0]=parseFloat(b,10)}if((b=e("CD2_2",g))){a.cd[1][1]=parseFloat(b,10)}for(var f=0;f<2;f++){for(var c=0;c<20;c++){if((b=e("PV"+(f+1)+"_"+c,g))){a.pv[f][c]=parseFloat(b,10)}}}},_deltaLng:function(b,c){var a=b.lng-c.lng;return a>180?a-360:(a<-180?a+360:a)}});L.CRS.WCS=L.Class.extend(L.CRS.WCS);L.CRS.wcs=function(a){return new L.CRS.WCS(a)};L.IIPUtils={REG_PDEC:"(\\d+\\.\\d*)",REG_FLOAT:"([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",requestURL:function(c,a,g,d,f){var b;if(window.XMLHttpRequest){b=new XMLHttpRequest()}else{if(window.ActiveXObject){try{b=new ActiveXObject("Msxml2.XMLHTTP")}catch(h){try{b=new ActiveXObject("Microsoft.XMLHTTP")}catch(h){}}}}if(!b){alert("Giving up: Cannot create an XMLHTTP instance for "+a);return false}if(f){b.timeout=f*1000;b.ontimeout=function(){alert("Time out while "+a)}}b.open("GET",c);if((d)&&(d.options.credentials)){b.withCredentials=true}if((d)&&(d.options.authenticate==="csrftoken")){b.setRequestHeader("X-CSRFToken",this.getCookie("csrftoken"))}b.onreadystatechange=function(){g(d,b)};b.send()},parseURL:function(a){var b={};a.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(d,c,f,e){b[c]=e});return b},updateURL:function(b,a,d){var c=new RegExp("([?&])"+a+"=.*?(&|$)","i"),e=b.indexOf("?")!==-1?"&":"?";return b.match(c)?b.replace(c,"$1"+a+"="+d+"$2"):b+e+a+"="+d},checkDomain:function(a){if(a.indexOf("//")===0){a=location.protocol+a}return a.toLowerCase().replace(/([a-z])?:\/\//,"$1").split("/")[0]},isExternal:function(a){return((a.indexOf(":")>-1||a.indexOf("//")>-1)&&this.checkDomain(location.href)!==this.checkDomain(a))},copyToClipboard:function(c){if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var a=document.createElement("textarea");a.textContent=c;a.style.position="fixed";document.body.appendChild(a);a.select();try{return document.execCommand("copy")}catch(b){console.warn("Copy to clipboard failed.",b);return false}finally{document.body.removeChild(a)}}},flashElement:function(a){L.DomUtil.addClass(a,"leaflet-control-flash");setTimeout(function(){L.DomUtil.removeClass(a,"leaflet-control-flash")},400)},readFITSKey:function(b,f){var d=b.trim().toUpperCase().substr(0,8),e=8-d.length,a=new RegExp(d+(e>0?"\\ {"+e.toString()+"}":"")+"=\\ *(?:'((?:\\ *[^'\\ ]+)*)\\ *'|([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?))"),c=a.exec(f);if(!c){return null}else{if(c[1]){return c[1]}else{return c[2]}}},distance:function(k,j){var e=Math.PI/180,g=k.lat*e,d=j.lat*e,h=d-g,b=(j.lng-k.lng)*e,f=Math.sin(h/2),c=Math.sin(b/2);var i=f*f+c*c*Math.cos(g)*Math.cos(d);return Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*360/Math.PI},getCookie:function(d){var b=d+"=";var a=document.cookie.split(";");for(var e=0;e<a.length;e++){var f=a[e];while(f.charAt(0)==" "){f=f.substring(1)}if(f.indexOf(b)===0){return f.substring(b.length,f.length)}}return""}};L.TileLayer.IIP=L.TileLayer.extend({options:{title:"",crs:null,nativeCelsys:false,center:false,fov:false,minZoom:0,maxZoom:null,maxNativeZoom:18,noWrap:true,contrast:1,colorSat:1,gamma:1,cMap:"grey",invertCMap:false,quality:90,mixingMode:"color",channelColors:[],channelLabels:[],channelLabelMatch:".*",channelUnits:[],minMaxValues:[],defaultChannel:0,credentials:false},iipdefault:{contrast:1,gamma:1,cMap:"grey",invertCMap:false,minValue:[],maxValue:[],channelColors:[[""],["#FFFFFF"],["#0000FF","#FFFF00"],["#0000FF","#00FF00","#FF0000"],["#0000FF","#00FFFF","#FFFF00","#FF0000"],["#0000FF","#00FFFF","#00FF00","#FFA000","#FF0000"],["#0000FF","#00FFFF","#00FF00","#FFFF00","#FFA000","#FF0000"]],quality:90},initialize:function(b,a){this.type="tilelayer";this._url=b.replace(/\&.*$/g,"");a=L.setOptions(this,a);if(a.detectRetina&&L.Browser.retina&&a.maxZoom>0){a.tileSize=Math.floor(a.tileSize/2);a.zoomOffset++;a.minZoom=Math.max(0,a.minZoom);a.maxZoom--}if(typeof a.subdomains==="string"){a.subdomains=a.subdomains.split("")}this.iipTileSize={x:256,y:256};this.iipImageSize=[];this.iipImageSize[0]=this.iipTileSize;this.iipGridSize=[];this.iipGridSize[0]={x:1,y:1};this.iipBPP=8;this.iipMode=a.mixingMode;this.iipChannel=0;this.iipNChannel=1;this.iipMinZoom=a.minZoom;this.iipMaxZoom=a.maxZoom;this.iipContrast=a.contrast;this.iipColorSat=a.colorSat;this.iipGamma=a.gamma;this.iipCMap=a.cMap;this.iipInvertCMap=a.invertCMap;this.iipMinValue=[];this.iipMinValue[0]=0;this.iipMaxValue=[];this.iipMaxValue[0]=255;this.iipMix=[[]];this.iipRGB=[];this.iipChannelLabels=[];this.iipChannelUnits=[];this.iipQuality=a.quality;this._title=a.title.length>0?a.title:this._url.match(/^.*\/(.*)\..*$/)[1];this.getIIPMetaData(this._url);if(!L.Browser.android){this.on("tileunload",this._onTileRemove)}return this},getIIPMetaData:function(a){L.IIPUtils.requestURL(a+"&obj=IIP,1.0&obj=max-size&obj=tile-size&obj=resolution-number&obj=bits-per-channel&obj=min-max-sample-values&obj=subject","getting IIP metadata",this._parseMetadata,this)},_parseMetadata:function(E,o){if(o.readyState===4){if(o.status===200){var d=o.responseText,e=E._readIIPKey(d,"IIP",L.IIPUtils.REG_PDEC);if(!e){alert("Error: Unexpected response from IIP server "+E._url.replace(/\?.*$/g,""))}var f=E.options,h=E.iipdefault;e=E._readIIPKey(d,"Max-size","(\\d+)\\s+(\\d+)");var C={x:parseInt(e[1],10),y:parseInt(e[2],10)};e=E._readIIPKey(d,"Tile-size","(\\d+)\\s+(\\d+)");E.iipTileSize={x:parseInt(e[1],10),y:parseInt(e[2],10)};f.tileSize=E.iipTileSize.x;e=E._readIIPKey(d,"Resolution-number","(\\d+)");E.iipMaxZoom=parseInt(e[1],10)-1;if(E.iipMinZoom>f.minZoom){f.minZoom=E.iipMinZoom}if(!f.maxZoom){f.maxZoom=E.iipMaxZoom+6}f.maxNativeZoom=E.iipMaxZoom;for(var m=0;m<=E.iipMaxZoom;m++){E.iipImageSize[m]={x:Math.floor(C.x/Math.pow(2,E.iipMaxZoom-m)),y:Math.floor(C.y/Math.pow(2,E.iipMaxZoom-m))};E.iipGridSize[m]={x:Math.ceil(E.iipImageSize[m].x/E.iipTileSize.x),y:Math.ceil(E.iipImageSize[m].y/E.iipTileSize.y)}}for(m=E.iipMaxZoom;m<=f.maxZoom;m++){E.iipGridSize[m]=E.iipGridSize[E.iipMaxZoom]}e=E._readIIPKey(d,"Bits-per-channel","(\\d+)");E.iipBPP=parseInt(e[1],10);if(E.iipGamma===E.iipdefault.gamma){E.iipGamma=E.iipBPP>=32?2.2:1}e=E._readIIPKey(d,"Min-Max-sample-values","\\s*(.*)");var v=e[1].split(/\s+/),n=E.iipNChannel=(v.length/2),j=0;for(var B=0;B<n;B++){h.minValue[B]=parseFloat(v[j++]);h.maxValue[B]=parseFloat(v[j++])}var k=f.minMaxValues;if(k.length){for(B=0;B<n;B++){if(k[B]!==undefined&&k[B].length){E.iipMinValue[B]=k[B][0];E.iipMaxValue[B]=k[B][1]}else{E.iipMinValue[B]=h.minValue[B];E.iipMaxValue[B]=h.maxValue[B]}}}else{for(B=0;B<n;B++){E.iipMinValue[B]=h.minValue[B];E.iipMaxValue[B]=h.maxValue[B]}}E.iipChannel=f.defaultChannel;var g=f.channelLabels,q=g.length,A=E.iipChannelLabels,D=f.channelUnits,y=D.length,w=E.iipChannelUnits,F=L.IIPUtils.readFITSKey,s,u;for(B=0;B<n;B++){if(B<q){A[B]=g[B]}else{s=(B+1).toString();u=F("CHAN"+(B<9?"000":(B<99?"00":(B<999?"0":"")))+s,d);A[B]=u?u:"Channel #"+s}}for(B=0;B<y;B++){w[B]=D[B]}for(B=y;B<n;B++){w[B]="ADUs"}var r=0,p=E.iipMix,a=f.channelColors,b=E.iipRGB,t=new RegExp(f.channelLabelMatch),x=0,l=[];x=0;for(B=0;B<n;B++){l[B]=t.test(A[B]);if(l[B]){x++}}if(x>=h.channelColors.length){x=h.channelColors.length-1}for(B=0;B<n;B++){p[B]=[];var i=3;if(a.length&&a[B]&&a[B].length===3){b[B]=L.rgb(a[B][0],a[B][1],a[B][2])}else{b[B]=L.rgb(0,0,0)}if(a.length===0&&l[B]&&r<x){b[B]=L.rgb(h.channelColors[x][r++])}E.rgbToMix(B)}if(f.bounds){f.bounds=L.latLngBounds(f.bounds)}E.wcs=f.crs?f.crs:new L.CRS.WCS(d,{nativeCelsys:E.options.nativeCelsys,nzoom:E.iipMaxZoom+1,tileSize:E.iipTileSize});E.iipMetaReady=true;E.fire("metaload")}else{alert("There was a problem with the IIP metadata request.")}}},rgbToMix:function(g,c){if(c){this.iipRGB[g]=c.clone()}else{c=this.iipRGB[g]}var e=this._gammaCorr(c.r),d=this._gammaCorr(c.g),b=this._gammaCorr(c.b),a=(e+d+b)/3,f=this.iipColorSat/3;this.iipMix[g][0]=a+f*(2*e-d-b);this.iipMix[g][1]=a+f*(2*d-e-b);this.iipMix[g][2]=a+f*(2*b-e-d);return},updateMono:function(){this.iipMode="mono"},updateMix:function(){var a=this.iipNChannel;this.iipMode="color";for(var b=0;b<a;b++){this.rgbToMix(b,this.iipRGB[b])}},_gammaCorr:function(a){return a>0?Math.pow(a,this.iipGamma):0},_readIIPKey:function(d,a,c){var b=new RegExp(a+":"+c);return b.exec(d)},addTo:function(a){if(this.iipMetaReady){this._addToMap(a)}else{this.once("metaload",function(){this._addToMap(a)},this)}return this},_addToMap:function(b){var i,g=this.wcs,e=b.options.crs,h=b._prevcrs,j=b._loaded,a=b.options.center?b.options.center:g.projparam.crval;if(j){e._prevLatLng=b.getCenter();e._prevZoom=b.getZoom()}b._prevcrs=b.options.crs=g;L.TileLayer.prototype.addTo.call(this,b);if(h&&g!==e&&j&&g.pixelFlag===e.pixelFlag){a=e._prevLatLng;i=e._prevZoom;var f=h.pixelScale(i,a),d=g.pixelScale(i,a);if(f>1e-20&&d>1e-20){i+=Math.round(Math.LOG2E*Math.log(d/f))}}else{if(g._prevLatLng){a=g._prevLatLng;i=g._prevZoom}else{if(this.options.center){var c=g.parseCoords(this.options.center);if(c){if(this.options.fov){i=g.fovToZoom(b,this.options.fov,c)}b.setView(c,i,{reset:true,animate:false})}else{L.IIPUtils.requestURL("http://cdsweb.u-strasbg.fr/cgi-bin/nph-sesame/-oI/A?"+this.options.center,"getting coordinates for "+this.options.center,function(n,k){if(k.readyState===4){if(k.status===200){var l=k.responseText,m=g.parseCoords(l,true);if(m){if(n.options.fov){i=g.fovToZoom(b,n.options.fov,m)}b.setView(m,i,{reset:true,animate:false})}else{b.setView(a,i,{reset:true,animate:false});alert(l+": Unknown location")}}else{b.setView(a,i,{reset:true,animate:false});alert("There was a problem with the request to the Sesame service at CDS")}}},this,10)}}else{b.setView(a,i,{reset:true,animate:false})}}}},_getTileSizeFac:function(){var c=this._map,b=this._tileZoom,a=this.options.maxNativeZoom;return(a&&b>a)?Math.round(c.getZoomScale(b)/c.getZoomScale(a)):1},_isValidTile:function(d){var b=this._map.options.crs;if(!b.infinite){var c=this._globalTileRange;if((!b.wrapLng&&(d.x<c.min.x||d.x>c.max.x))||(!b.wrapLat&&(d.y<c.min.y||d.y>c.max.y))){return false}}var f=this._getZoomForUrl(),a=d.clone();this._wrapCoords(a);if(a.x<0||a.x>=this.iipGridSize[f].x||a.y<0||a.y>=this.iipGridSize[f].y){return false}if(!this.options.bounds){return true}var e=this._tileCoordsToBounds(d);return L.latLngBounds(this.options.bounds).intersects(e)},createTile:function(c,a){var b=L.TileLayer.prototype.createTile.call(this,c,a);b.coords=c;return b},getTileUrl:function(i){var f=this._url,g=this._getZoomForUrl();if(this.iipCMap!==this.iipdefault.cMap){f+="&CMP="+this.iipCMap}if(this.iipInvertCMap!==this.iipdefault.invertCMap){f+="&INV"}if(this.iipContrast!==this.iipdefault.contrast){f+="&CNT="+this.iipContrast.toString()}if(this.iipGamma!==this.iipdefault.gamma){f+="&GAM="+(1/this.iipGamma).toFixed(4)}for(var e=0;e<this.iipNChannel;e++){if(this.iipMinValue[e]!==this.iipdefault.minValue[e]||this.iipMaxValue[e]!==this.iipdefault.maxValue[e]){f+="&MINMAX="+(e+1).toString()+":"+this.iipMinValue[e].toString()+","+this.iipMaxValue[e].toString()}}var h=this.iipNChannel,j=this.iipMix,d,a;f+="&CTW=";if(this.iipMode==="color"){for(a=0;a<3;a++){if(a){f+=";"}f+=j[0][a].toString();for(d=1;d<h;d++){if(j[d][a]!==undefined){f+=","+j[d][a].toString()}}}}else{var b=this.iipChannel;if(b>=h){b=0}if(b<h){h=b+1}for(a=0;a<3;a++){if(a){f+=";"}f+=(b===0?"1":"0");for(d=1;d<h;d++){f+=","+(b===d?"1":"0")}}}if(this.iipQuality!==this.iipdefault.quality){f+="&QLT="+this.iipQuality.toString()}return f+"&JTL="+g.toString()+","+(i.x+this.iipGridSize[g].x*i.y).toString()},_initTile:function(b){L.DomUtil.addClass(b,"leaflet-tile");var e=this._getTileSizeFac();if(e>1){if(L.Browser.ie){b.style.msInterpolationMode="nearest-neighbor"}else{if(L.Browser.chrome){b.style.imageRendering="pixelated"}else{if(L.Browser.gecko){b.style.imageRendering="-moz-crisp-edges"}else{b.style.imageRendering="-webkit-optimize-contrast"}}}}var c=b.coords,d=c.z;if(d>this.iipMaxZoom){d=this.iipMaxZoom}var a=c.x+1===this.iipGridSize[d].x?this.iipImageSize[d].x%this.iipTileSize.x:this.iipTileSize.x,f=c.y+1===this.iipGridSize[d].y?this.iipImageSize[d].y%this.iipTileSize.y:this.iipTileSize.y;if(a===0){a=this.iipTileSize.x}if(f===0){f=this.iipTileSize.y}a*=e;f*=e;b.style.width=a+"px";b.style.height=f+"px";b.onselectstart=L.Util.falseFn;b.onmousemove=L.Util.falseFn;if(L.Browser.ielt9&&this.options.opacity<1){L.DomUtil.setOpacity(b,this.options.opacity)}if(L.Browser.android&&!L.Browser.android23){b.style.WebkitBackfaceVisibility="hidden"}}});L.tileLayer.iip=function(b,a){return new L.TileLayer.IIP(b,a)};L.RGB=function(d,c,a){this.r=d;this.g=c;this.b=a};L.RGB.prototype={clone:function(){return new L.RGB(this.r,this.g,this.b)},toStr:function(){var d=Math.round(this.r*255),c=Math.round(this.g*255),a=Math.round(this.b*255);if(d<0){d=0}else{if(d>255){d=255}}if(c<0){c=0}else{if(c>255){c=255}}if(a<0){a=0}else{if(a>255){a=255}}return"#"+((1<<24)+(d<<16)+(c<<8)+a).toString(16).slice(1)},isOn:function(){return(this.r>0||this.g>0||this.b>0)?true:false}};L.rgb=function(d,c,a){if(d instanceof L.RGB){return d}if(typeof d==="string"){var e=parseInt("0x"+d.slice(1),16);return new L.RGB(((e>>16)&255)/255,((e>>8)&255)/255,(e&255)/255)}if(L.Util.isArray(d)){return new L.RGB(d[0],d[1],d[2])}if(d===undefined||d===null){return d}return new L.RGB(d,c,a)};L.EllipseMarker=L.Path.extend({CANVAS:true,SVG:false,options:{fill:true,majAxis:10,minAxis:10,posAngle:0},initialize:function(d,n){L.setOptions(this,n);this._majAxis=this.options.majAxis;this._minAxis=this.options.majAxis;this._posAngle=this.options.posAngle;this._latlng=L.latLng(d);var b=Math.PI/180,e=Math.cos(this._posAngle*b),m=Math.sin(this._posAngle*b),h=e*e,g=m*m,a=this._majAxis*this._majAxis,k=this._minAxis*this._minAxis,l=a*h+k*g,f=a*g+k*h,j=(a-k)*e*m,i=l*f-j*j;this._limX=Math.sqrt(l);this._limY=Math.sqrt(f);if(i<=0){l+=1;f+=1;i=l*f-j*j}this._cXX=f/i;this._cYY=l/i;this._cXY=-2*j/i},setLatLng:function(a){this._latlng=L.latLng(a);this.redraw();return this.fire("move",{latlng:this._latlng})},getLatLng:function(){return this._latlng},setParams:function(a){this.options.majAxis=this._majAxis=a.majAxis;this.options.minAxis=this._minAxis=a.minAxis;this.options.posAngle=this._posAngle=a.posAngle;return this.redraw()},getParams:function(){var a;a.majAxis=this._majAxis;a.minAxis=this._minAxis;a.posAngle=this._posAngle;return a},setStyle:L.Path.prototype.setStyle,_project:function(){this._point=this._map.latLngToLayerPoint(this._latlng);this._updateBounds()},_updateBounds:function(){var a=this._clickTolerance(),b=[this._limX+a,this._limY+a];this._pxBounds=new L.Bounds(this._point.subtract(b),this._point.add(b))},_update:function(){if(this._map){this._updatePath()}},_updatePath:function(){this._renderer._updateEllipse(this)},_empty:function(){return this._majAxis&&!this._renderer._bounds.intersects(this._pxBounds)},_containsPoint:function(d){var e=d.subtract(this._point),c=this._clickTolerance(),b=Math.abs(e.x)-c,a=Math.abs(e.y)-c;return this._cXX*(b>0?b*b:0)+this._cYY*(a>0?a*a:0)+this._cXY*(e.x*e.y)<=1}});L.ellipseMarker=function(b,a){return new L.EllipseMarker(b,a)};L.Canvas.include({_updateEllipse:function(b){if(b._empty()){return}var e=b._point,a=this._ctx,d=b._minAxis,c=b._majAxis/b._minAxis;a.save();a.translate(e.x,e.y);a.rotate(b._posAngle*Math.PI/180);a.scale(1,c);a.beginPath();a.arc(0,0,d,0,Math.PI*2,false);a.restore();this._fillStroke(a,b)}});L.SVG.include({_updateEllipse:function(g){var c=Math.PI/180,b=g._point,a=g._minAxis,f=g._majAxis,j=a*Math.cos(g._posAngle*c),i=a*Math.sin(g._posAngle*c),e="a"+a+","+f+" "+g._posAngle+" 1,0 ";var h=g._empty()?"M0 0":"M"+(b.x-j)+","+(b.y-i)+e+(j*2)+","+(i*2)+" "+e+(-j*2)+","+(-i*2)+" ";this._setPath(g,h)}});L.Ellipse=L.EllipseMarker.extend({options:{fill:true},initialize:function(c,i){L.setOptions(this,i);var b=Math.PI/180,d=Math.cos(this.options.posAngle*b),h=Math.sin(this.options.posAngle*b),f=d*d,e=h*h,a=this.options.majAxis*this.options.majAxis,g=this.options.minAxis*this.options.minAxis;this._latlng=L.latLng(c);this._mLat2=a*f+g*e;this._mLng2=a*e+g*f;this._mLatLng=(a-g)*d*h},getBounds:function(){var a=[this._limX,this._limY];return new L.LatLngBounds(this._map.layerPointToLatLng(this._point.subtract(a)),this._map.layerPointToLatLng(this._point.add(a)))},_project:function(){var r=this._map,d=r.options.crs;this._point=r.latLngToLayerPoint(this._latlng);if(!this._majAxis1){var v=this._latlng.lng,f=this._latlng.lat,j=Math.PI/180,b=Math.cos(f*j),o=f<90?0.001:-0.001,l=d.project(this._latlng),e=d.project(L.latLng(f+o,v)).subtract(l),p=d.project(L.latLng(f,v+o*1/(b>o?b:o))).subtract(l),h=e.x/o,g=p.x/o,n=e.y/o,m=p.y/o,c=h*h*this._mLat2+g*g*this._mLng2+2*h*g*this._mLatLng,i=n*n*this._mLat2+m*m*this._mLng2+2*n*m*this._mLatLng,k=h*n*this._mLat2+g*m*this._mLng2+(h*m+g*n)*this._mLatLng,u=0.5*(c+i),s=Math.sqrt(0.25*(c-i)*(c-i)+k*k),q=c*i-k*k;this._majAxis=this._majAxis1=Math.sqrt(u+s);this._minAxis=this._minAxis1=u>s?Math.sqrt(u-s):0;this._posAngle=0.5*Math.atan2(2*k,c-i)/j;this._limX=this._limX1=Math.sqrt(c);this._limY=this._limY1=Math.sqrt(i);if(q<=0){c+=1;i+=1;q=c*i-k*k}this._cXX1=i/q;this._cYY1=c/q;this._cXY1=-2*k/q}var t=d.scale(r._zoom),a=1/(t*t);this._majAxis=this._majAxis1*t;this._minAxis=this._minAxis1*t;this._limX=this._limX1*t;this._limY=this._limY1*t;this._cXX=this._cXX1*a;this._cYY=this._cYY1*a;this._cXY=this._cXY1*a;this._updateBounds()}});L.ellipse=function(b,a){return new L.Ellipse(b,a)};L.Catalog={nmax:10000,_csvToGeoJSON:function(f){var h=new RegExp("#|--|^$"),n=f.split("\n"),b={type:"FeatureCollection",features:[]};for(var c in n){var o=n[c];if(h.test(o)===false){var m={type:"Feature",id:"",properties:{items:[]},geometry:{type:"Point",coordinates:[0,0]},},g=m.geometry,e=m.properties;var k=o.split(/[,;\t]/);m.id=k[0];g.coordinates[0]=parseFloat(k[1]);g.coordinates[1]=parseFloat(k[2]);var d=k.slice(3),l;for(var a in d){l=parseFloat(d[a]);e.items.push(isNaN(l)?"--":l)}b.features.push(m)}}return b},toGeoJSON:function(a){return this._csvToGeoJSON(a)},popup:function(b){var c="<div>";if(this.objurl){c+='ID: <a href="'+L.Util.template(this.objurl,L.extend({ra:b.geometry.coordinates[0].toFixed(6),dec:b.geometry.coordinates[1].toFixed(6)}))+'" target="_blank">'+b.id+"</a></div>"}else{c+="ID: "+b.id+"</div>"}c+='<TABLE style="margin:auto;"><TBODY style="vertical-align:top;text-align:left;">';for(var a in this.properties){c+="<TR><TD>"+this.properties[a]+":</TD><TD>"+b.properties.items[a].toString()+" ";if(this.units[a]){c+=this.units[a]}c+="</TD></TR>"}c+="</TBODY></TABLE>";return c},draw:function(a,b){return L.circleMarker(b,{radius:a.properties.items[0]?5+17-a.properties.items[0]:8})},vizierURL:"http://vizier.u-strasbg.fr/viz-bin",};L.Catalog["2MASS"]=L.extend({},L.Catalog,{name:"2MASS",attribution:"2MASS All-Sky Catalog of Point Sources (Cutri et al. 2003)",color:"red",maglim:17,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=II/246&-out=2MASS,RAJ2000,DEJ2000,Jmag,Hmag,Kmag&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["J","H","K"],units:["","",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=II/246&-c={ra},{dec},eq=J2000&-c.rs=0.01"});L.Catalog.SDSS=L.extend({},L.Catalog,{name:"SDSS release 9",attribution:"SDSS Photometric Catalog, Release 9 (Adelman-McCarthy et al. 2012)",color:"yellow",maglim:25,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=V/139&-out=SDSS9,RAJ2000,DEJ2000,umag,gmag,rmag,imag,zmag&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-sort=imag&-out.max={nmax}",properties:["u","g","r","i","z"],units:["","","","",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=V/139/sdss9&-c={ra},{dec},eq=J2000&-c.rs=0.01"});L.Catalog.PPMXL=L.extend({},L.Catalog,{name:"PPMXL",attribution:"PPM-Extended, positions and proper motions by Roeser et al. 2008",color:"green",maglim:20,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=I/317&-out=PPMXL,RAJ2000,DEJ2000,Jmag,Hmag,Kmag,b1mag,b2mag,r1mag,r2mag,imag,pmRA,pmDE&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["J","H","K","b<sub>1</sub>","b<sub>2</sub>","r<sub>1</sub>","r<sub>2</sub>","i","&#956;<sub>&#593;</sub> cos &#948;","&#956;<sub>&#948;</sub>"],units:["","","","","","","","","mas/yr","mas/yr"],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=I/317&-c={ra},{dec},eq=J2000&-c.rs=0.01"});L.Catalog.Abell=L.extend({},L.Catalog,{name:"Abell clusters",attribution:"Rich Clusters of Galaxies (Abell et al. 1989) ",color:"orange",maglim:30,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=VII/110A&-out=ACO,_RAJ2000,_DEJ2000,m10,Rich,Dclass&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["m<sub>10</sub>","Richness","D<sub>class</sub>"],units:["","",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=VII/110A&-c={ra},{dec},eq=J2000&-c.rs=0.2"});L.Catalog.NVSS=L.extend({},L.Catalog,{name:"NVSS",attribution:"1.4GHz NRAO VLA Sky Survey (NVSS) (Condon et al. 1998)",color:"magenta",maglim:30,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=VIII/65/NVSS&-out=NVSS,_RAJ2000,_DEJ2000,S1.4,MajAxis,MinAxis,PA&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["S<sub>1.4GHz</sub>","Major axis","Minor axis","Position angle"],units:["mJy","&#8243;","&#8243;","&#176;"],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=VIII/65/NVSS&-c={ra},{dec},eq=J2000&-c.rs=0.2",draw:function(a,b){return L.ellipse(b,{majAxis:a.properties.items[1]/7200,minAxis:a.properties.items[2]/7200,posAngle:a.properties.items[3]==="--"?90:90-a.properties.items[3]})}});L.Catalog.FIRST=L.extend({},L.Catalog,{name:"FIRST",attribution:"The FIRST Survey Catalog (Helfand et al. 2015)",color:"blue",maglim:30,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=VIII/92/first14&-out=FIRST,_RAJ2000,_DEJ2000,Fpeak,fMaj,fMin,fPA&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["F<sub>peak</sub>(1.4GHz)","Major axis FWHM","Minor axis FWHM","Position angle"],units:["mJy","&#8243;","&#8243;","&#176;"],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=VIII/92/first14&-c={ra},{dec},eq=J2000&-c.rs=0.2",draw:function(a,b){return L.ellipse(b,{majAxis:a.properties.items[1]/7200,minAxis:a.properties.items[2]/7200,posAngle:a.properties.items[3]==="--"?90:90-a.properties.items[3]})}});L.Catalog.AllWISE=L.extend({},L.Catalog,{name:"AllWISE",attribution:"AllWISE Data Release (Cutri et al. 2013)",color:"red",maglim:18,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=II/328/allwise&-out=AllWISE,_RAJ2000,_DEJ2000,W1mag,W2mag,W3mag,W4mag&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["W1<sub>mag</sub> (3.4µm)","W2<sub>mag</sub> (4.6µm)","W3<sub>mag</sub> (12µm)","W4<sub>mag</sub> (22µm)"],units:["","","",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=II/328/allwise&-c={ra},{dec},eq=J2000&-c.rs=0.2"});L.Catalog.GALEX_AIS=L.extend({},L.Catalog,{name:"GALEX AIS",attribution:"GALEX catalogs of UV sources: All-sky Imaging Survey (Bianchi et al. 2011)",color:"magenta",maglim:21,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=II/312/ais&-out=objid,_RAJ2000,_DEJ2000,FUV,NUV&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["FUV<sub>AB</sub>","NUV<sub>AB</sub>"],units:["",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=II/312/ais&-c={ra},{dec},eq=J2000&-c.rs=0.2"});L.Catalog.GAIA_DR1=L.extend({},L.Catalog,{name:"Gaia DR1",attribution:"First Gaia Data Release (2016)",color:"green",maglim:20,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=I/337&-out=Source,RA_ICRS,DE_ICRS,<Gmag>,pmRA,pmDE&-out.meta=&-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["G","&#956;<sub>&#593;</sub> cos &#948;","&#956;<sub>&#948;</sub>"],units:["","mas/yr","mas/yr"],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=I/337&-c={ra},{dec},eq=J2000&-c.rs=0.01"});L.Catalog.Y3A1=L.extend({},L.Catalog,{name:"Y3A1",attribution:"Des Y3A1 COADD OBJECT SUMMARY",color:"blue",maglim:27,service:"ScienceServer",regionType:"box",authenticate:"csrftoken",url:"http://desportal.cosmology.illinois.edu:8080/dri/api/visiomatic/coadd_objects/?mime=csv&product=27&source=Y3A1_COADD_OBJECT_SUMMARY&columns=COADD_OBJECT_ID,RA,DEC,MAG_AUTO_G,MAG_AUTO_R,MAG_AUTO_I,MAG_AUTO_Z,MAG_AUTO_Y&coordinate={lng},{lat}&bounding={dlng},{dlat}&maglim={maglim}&limit=2000",properties:["MAG_AUTO_G","MAG_AUTO_R","MAG_AUTO_I","MAG_AUTO_Z","MAG_AUTO_Y"],units:[],});L.FlipSwitch=L.Evented.extend({options:{checked:false,title:"Click to switch",className:"leaflet-flipswitch",id:"leaflet-flipswitch"},initialize:function(f,c){c=L.setOptions(this,c);var g=this,e=c.className,d=L.DomUtil.create("div",e,f),a=this._input=L.DomUtil.create("input",e,d),b=L.DomUtil.create("label",e,d);a.type="checkbox";a.name=c.className;a.checked=c.checked;b.htmlFor=a.id=c.id;if(c.title){b.title=c.title}L.DomUtil.create("span",e+"-inner",b);L.DomUtil.create("span",e+"-button",b);L.DomEvent.disableClickPropagation(d).disableScrollPropagation(d);L.DomEvent.on(a,"change",function(){this.fire("change")},this);return d},value:function(a){if(a===undefined){return this._input.checked}else{this._input.checked=a?true:false;return this}}});L.flipswitch=function(b,a){return new L.FlipSwitch(b,a)};L.SpinBox=L.Evented.extend({options:{dmin:undefined,dmax:undefined,step:undefined,initValue:undefined,repButton:true,clickEvent:"click",instantUpdate:false,title:"Enter value",className:"leaflet-spinbox"},initialize:function(f,c){c=L.setOptions(this,c);var h=this,e=this._drag={startEvent:"touchstart mousedown",stopEvent:"touchend mouseup mouseout touchcancel",move:false,start:false,end:false,pos:false,target:false,delta:false,tmp:false,cnt:0,step:c.step,prec:this._prec(c.step)},d=this._wrap=L.DomUtil.create("div",c.className,f),b=this._input=L.DomUtil.create("input",c.className+"-input",d),g=this._down=L.DomUtil.create("div",c.className+"-down",d),a=this._up=L.DomUtil.create("div",c.className+"-up",d);b.type="number";b.step=0.1;L.DomEvent.disableClickPropagation(d).disableScrollPropagation(d);if(b.disabled===true){c.disabled=true}if(c.dmin===undefined){c.dmin=-Number.MAX_VALUE}if(c.dmax===undefined){c.dmax=Number.MAX_VALUE}if(c.step===undefined){c.step=1}if(c.initValue===undefined){c.initValue=(c.dmin+c.dmax)/2}this.value(c.initValue);b.title=c.title;g.title="Decrease number by "+c.step;a.title="Increase number by "+c.step;L.DomEvent.on(this._input,"change",function(){this.fire("change")},this);if(c.repButton===false){L.DomEvent.on(g,c.clickEvent,function(i){i.preventDefault();this._offset(i.currentTarget,-1)},this);L.DomEvent.on(a,c.clickEvent,function(i){i.preventDefault();this._offset(i.currentTarget,1)},this)}else{L.DomEvent.on(g,e.startEvent,function(i){b.blur();e.move=true;e.cnt=0;e.step=c.step;e.prec=this._prec(e.step);e.delta=-1;this._offset(i.currentTarget,-1);if(!this.runButton){e.target=i.currentTarget;this.runButton=setTimeout(function(){h._sboxRun()},500)}},this);L.DomEvent.on(a,e.startEvent,function(i){b.blur();e.move=true;e.cnt=0;e.step=c.step;e.prec=this._prec(e.step);e.delta=1;this._offset(i.currentTarget,1);if(!this.runButton){e.target=i.currentTarget;this.runButton=setTimeout(function(){h._sboxRun()},500)}},this);L.DomEvent.on(g,e.stopEvent,function(i){if(e.move){i.preventDefault();clearTimeout(this.runButton);this.runButton=false;e.move=false;if(c.instantUpdate===false){this.fire("change")}}},this);L.DomEvent.on(a,e.stopEvent,function(i){if(e.move){i.preventDefault();clearTimeout(this.runButton);this.runButton=false;e.move=false;if(c.instantUpdate===false){this.fire("change")}}},this)}if(c.disabled){this.disable()}return d},value:function(a){if(a===undefined){return parseFloat(this._input.value)}else{this._input.value=a;return this}},step:function(a){if(a===undefined){return this.options.step}else{this.options.step=a;return this}},disable:function(){var a="disabled";this._input.disabled=true;this._input.blur();L.DomUtil.addClass(this._wrap,a);L.DomUtil.addClass(this._down,a);L.DomUtil.addClass(this._up,a);this.options.disabled=true},enable:function(){var a="disabled";this._input.disabled=false;L.DomUtil.removeClass(this._wrap,a);L.DomUtil.removeClass(this._down,a);L.DomUtil.removeClass(this._up,a);this.options.disabled=false},_sboxRun:function(){var d=this,c=150,a=this.options,b=this._drag;if(b.cnt===20){c=50;b.step=10*a.step;b.prec=this._prec(b.step)}else{if(b.cnt===40){c=10;b.step=100*a.step;b.prec=this._prec(b.step)}else{if(b.cnt===60){b.step=1000*a.step;b.prec=this._prec(b.step)}else{if(b.cnt===80){b.step=10000*a.step;b.prec=this._prec(b.step)}}}}b.didRun=true;this._offset(this,b.delta);b.cnt++;this.runButton=setTimeout(function(){d._sboxRun()},c)},_prec:function(a){var b=-0.4342944*Math.log(a);return b>0?Math.ceil(b):0},_offset:function(f,e){var c,b=this.options,a=this._input,d=this._drag;if(!this.disabled){if(e<1){c=(parseFloat(a.value)-d.step).toFixed(d.prec);if(c>=b.dmin){a.value=c;if(b.instantUpdate===true){this.fire("change")}}}else{c=(parseFloat(a.value)+d.step).toFixed(d.prec);if(c<=b.dmax){a.value=c;if(b.instantUpdate===true){this.fire("change")}}}}}});L.spinbox=function(b,a){return new L.SpinBox(b,a)};if(typeof require!=="undefined"){var $=require("jquery-browser")}$.extend($.fn,{fileTree:function(a,b){if(a.root===undefined){a.root="/"}if(a.script===undefined){a.script="dist/filetree.php"}if(a.folderEvent===undefined){a.folderEvent="click"}if(a.expandSpeed===undefined){a.expandSpeed=500}if(a.collapseSpeed===undefined){a.collapseSpeed=500}if(a.expandEasing===undefined){a.expandEasing=null}if(a.collapseEasing===undefined){a.collapseEasing=null}if(a.multiFolder===undefined){a.multiFolder=true}if(a.loadMessage===undefined){a.loadMessage="Loading..."}$(this).each(function(){function d(f,e){$(f).addClass("wait");$(".filetree.start").remove();$.post(a.script,{dir:e},function(g){$(f).find(".start").html("");$(f).removeClass("wait").append(g);if(a.root===e){$(f).find("UL:hidden").show()}else{$(f).find("UL:hidden").slideDown({duration:a.expandSpeed,easing:a.expandEasing})}c(f)})}function c(e){$(e).find("LI A").on(a.folderEvent,function(){if($(this).parent().hasClass("directory")){if($(this).parent().hasClass("collapsed")){if(!a.multiFolder){$(this).parent().parent().find("UL").slideUp({duration:a.collapseSpeed,easing:a.collapseEasing});$(this).parent().parent().find("LI.directory").removeClass("expanded").addClass("collapsed")}$(this).parent().find("UL").remove();d($(this).parent(),encodeURI($(this).attr("rel").match(/.*\//)));$(this).parent().removeClass("collapsed").addClass("expanded")}else{$(this).parent().find("UL").slideUp({duration:a.collapseSpeed,easing:a.collapseEasing});$(this).parent().removeClass("expanded").addClass("collapsed")}}else{b($(this).attr("rel"))}return false});if(a.folderEvent.toLowerCase!=="click"){$(e).find("LI A").on("click",function(){return false})}}$(this).html('<ul class="filetree start"><li class="wait">'+a.loadMessage+"<li></ul>");d($(this),encodeURI(a.root))})}});L.Control.Attribution.include({_update:function(){if(!this._map){return}var c=[];for(var a in this._attributions){if(this._attributions[a]){c.push(a)}}var b=[];if(this.options.prefix){b.push(this.options.prefix)}if(c.length){b.push(c.join(", "))}this._container.innerHTML=b.join(" &#169; ")}});L.Map.addInitHook(function(){if(this.options.visiomaticLogo!==false&&this.options.attributionControl){this.attributionControl.setPrefix('<a id="logo-visiomatic" class="leaflet-control-attribution-logo"href="http://visiomatic.org">&nbsp;</a><a id="logo-iipimage" class="leaflet-control-attribution-logo"href="http://iipimage.sourceforge.net">&nbsp;</a><a id="logo-leaflet" class="leaflet-control-attribution-logo"href="http://leafletjs.com">&nbsp;</a>')}});L.Control.ExtraMap=L.Control.extend({options:{position:"bottomright",title:"Navigation mini-map. Grab to navigate",toggleDisplay:true,zoomLevelFixed:false,zoomLevelOffset:-5,zoomAnimation:false,autoToggleDisplay:false,width:150,height:150,collapsedWidth:24,collapsedHeight:24,aimingRectOptions:{color:"#FFFFFF",weight:1,clickable:false},shadowRectOptions:{color:"#FDC82F",weight:1,clickable:false,opacity:0,fillOpacity:0},strings:{hideText:"Hide map",showText:"Show map"}},initialize:function(b,a){L.Util.setOptions(this,a);this.options.aimingRectOptions.clickable=false;this.options.shadowRectOptions.clickable=false;this._layer=b},onAdd:function(a){this._mainMap=a;this._container=L.DomUtil.create("div","leaflet-control-extramap");this._container.style.width=this.options.width+"px";this._container.style.height=this.options.height+"px";this._container.title=this.options.title;L.DomEvent.disableClickPropagation(this._container);L.DomEvent.on(this._container,"mousewheel",L.DomEvent.stopPropagation);this._extraMap=new L.Map(this._container,{attributionControl:false,zoomControl:false,zoomAnimation:this.options.zoomAnimation,autoToggleDisplay:this.options.autoToggleDisplay,touchZoom:!this._isZoomLevelFixed(),scrollWheelZoom:!this._isZoomLevelFixed(),doubleClickZoom:!this._isZoomLevelFixed(),boxZoom:!this._isZoomLevelFixed(),});this._layer.addTo(this._extraMap);this._userToggledDisplay=false;this._minimized=false;if(this.options.toggleDisplay){this._addToggleButton()}this._layer.once("metaload",function(){this._mainMap.whenReady(L.Util.bind(function(){this._extraMap.whenReady(L.Util.bind(function(){this._aimingRect=L.rectangle(this._mainMap.getBounds(),this.options.aimingRectOptions).addTo(this._extraMap);this._shadowRect=L.rectangle(this._mainMap.getBounds(),this.options.shadowRectOptions).addTo(this._extraMap);this._mainMap.on("moveend",this._onMainMapMoved,this);this._mainMap.on("move",this._onMainMapMoving,this);this._extraMap.on("movestart",this._onExtraMapMoveStarted,this);this._extraMap.on("move",this._onExtraMapMoving,this);this._extraMap.on("moveend",this._onExtraMapMoved,this);this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(true));this._setDisplay(this._decideMinimized())},this))},this))},this);return this._container},addTo:function(a){L.Control.prototype.addTo.call(this,a);return this},onRemove:function(a){this._mainMap.off("moveend",this._onMainMapMoved,this);this._mainMap.off("move",this._onMainMapMoving,this);this._extraMap.off("moveend",this._onExtraMapMoved,this);this._extraMap.removeLayer(this._layer)},changeLayer:function(a){this._extraMap.removeLayer(this._layer);this._layer=a;this._extraMap.addLayer(this._layer)},_addToggleButton:function(){this._toggleDisplayButton=this.options.toggleDisplay?this._createButton("",this.options.strings.hideText,("leaflet-control-extramap-toggle-display leaflet-control-extramap-toggle-display-"+this.options.position),this._container,this._toggleDisplayButtonClicked,this):undefined;this._toggleDisplayButton.style.width=this.options.collapsedWidth+"px";this._toggleDisplayButton.style.height=this.options.collapsedHeight+"px"},_createButton:function(d,h,f,a,e,c){var g=L.DomUtil.create("a",f,a);g.innerHTML=d;g.href="#";g.title=h;var b=L.DomEvent.stopPropagation;L.DomEvent.on(g,"click",b).on(g,"mousedown",b).on(g,"dblclick",b).on(g,"click",L.DomEvent.preventDefault).on(g,"click",e,c);return g},_toggleDisplayButtonClicked:function(){this._userToggledDisplay=true;if(!this._minimized){this._minimize();this._toggleDisplayButton.title=this.options.strings.showText}else{this._restore();this._toggleDisplayButton.title=this.options.strings.hideText}},_setDisplay:function(a){if(a!==this._minimized){if(!this._minimized){this._minimize()}else{this._restore()}}},_minimize:function(){if(this.options.toggleDisplay){this._container.style.width=this.options.collapsedWidth+"px";this._container.style.height=this.options.collapsedHeight+"px";this._toggleDisplayButton.className+=(" minimized-"+this.options.position)}else{this._container.style.display="none"}this._minimized=true},_restore:function(){if(this.options.toggleDisplay){this._container.style.width=this.options.width+"px";this._container.style.height=this.options.height+"px";this._toggleDisplayButton.className=this._toggleDisplayButton.className.replace("minimized-"+this.options.position,"")}else{this._container.style.display="block"}this._minimized=false},_onMainMapMoved:function(a){if(!this._extraMapMoving){this._mainMapMoving=true;this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(true));this._setDisplay(this._decideMinimized())}else{this._extraMapMoving=false}this._aimingRect.setBounds(this._mainMap.getBounds())},_onMainMapMoving:function(a){this._aimingRect.setBounds(this._mainMap.getBounds())},_onExtraMapMoveStarted:function(d){var b=this._aimingRect.getBounds();var a=this._extraMap.latLngToContainerPoint(b.getSouthWest());var c=this._extraMap.latLngToContainerPoint(b.getNorthEast());this._lastAimingRectPosition={sw:a,ne:c}},_onExtraMapMoving:function(a){if(!this._mainMapMoving&&this._lastAimingRectPosition){this._shadowRect.setBounds(new L.LatLngBounds(this._extraMap.containerPointToLatLng(this._lastAimingRectPosition.sw),this._extraMap.containerPointToLatLng(this._lastAimingRectPosition.ne)));this._shadowRect.setStyle({opacity:1,fillOpacity:0.3})}},_onExtraMapMoved:function(a){if(!this._mainMapMoving){this._extraMapMoving=true;this._mainMap.setView(this._extraMap.getCenter(),this._decideZoom(false));this._shadowRect.setStyle({opacity:0,fillOpacity:0})}else{this._mainMapMoving=false}},_isZoomLevelFixed:function(){var a=this.options.zoomLevelFixed;return this._isDefined(a)&&this._isInteger(a)},_decideZoom:function(b){if(!this._isZoomLevelFixed()){if(b){return this._mainMap.getZoom()+this.options.zoomLevelOffset}else{var c=this._extraMap.getZoom()-this._mainMap.getZoom();var a=this._extraMap.getZoom()-this.options.zoomLevelOffset;var d;if(c>this.options.zoomLevelOffset&&this._mainMap.getZoom()<this._extraMap.getMinZoom()-this.options.zoomLevelOffset){if(this._extraMap.getZoom()>this._lastExtraMapZoom){d=this._mainMap.getZoom()+1;this._extraMap.setZoom(this._extraMap.getZoom()-1)}else{d=this._mainMap.getZoom()}}else{d=a}this._lastExtraMapZoom=this._extraMap.getZoom();return d}}else{if(b){return this.options.zoomLevelFixed}else{return this._mainMap.getZoom()}}},_decideMinimized:function(){if(this._userToggledDisplay){return this._minimized}if(this.options.autoToggleDisplay){if(this._mainMap.getBounds().contains(this._extraMap.getBounds())){return true}return false}return this._minimized},_isInteger:function(a){return typeof a==="number"},_isDefined:function(a){return typeof a!=="undefined"},});L.Map.mergeOptions({extraMapControl:false});L.Map.addInitHook(function(){if(this.options.extraMapControl){this.extraMapControl=(new L.Control.ExtraMap()).addTo(this)}});L.control.extraMap=function(b,a){return new L.Control.ExtraMap(b,a)};if(typeof require!=="undefined"){var jQuery=require("jquery-browser")}(function(){L.Control.FullScreen=L.Control.extend({options:{position:"topleft",title:"Toggle full screen mode",forceSeparateButton:false},onAdd:function(g){var f="leaflet-control-zoom-fullscreen",e;if(g.zoomControl&&!this.options.forceSeparateButton){e=g.zoomControl._container}else{e=L.DomUtil.create("div","leaflet-bar")}this._createButton(this.options.title,f,e,this.toogleFullScreen,g);return e},_createButton:function(j,h,e,g,f){var i=L.DomUtil.create("a",h,e);i.href="#";i.title=j;L.DomEvent.addListener(i,"click",L.DomEvent.stopPropagation).addListener(i,"click",L.DomEvent.preventDefault).addListener(i,"click",g,f);L.DomEvent.addListener(e,d.fullScreenEventName,L.DomEvent.stopPropagation).addListener(e,d.fullScreenEventName,L.DomEvent.preventDefault).addListener(e,d.fullScreenEventName,this._handleEscKey,f);L.DomEvent.addListener(document,d.fullScreenEventName,L.DomEvent.stopPropagation).addListener(document,d.fullScreenEventName,L.DomEvent.preventDefault).addListener(document,d.fullScreenEventName,this._handleEscKey,f);return i},toogleFullScreen:function(){this._exitFired=false;var e=this._container;if(this._isFullscreen){if(d.supportsFullScreen){d.cancelFullScreen(e)}else{L.DomUtil.removeClass(e,"leaflet-pseudo-fullscreen")}this.invalidateSize();this.fire("exitFullscreen");this._exitFired=true;this._isFullscreen=false}else{if(d.supportsFullScreen){d.requestFullScreen(e)}else{L.DomUtil.addClass(e,"leaflet-pseudo-fullscreen")}this.invalidateSize();this.fire("enterFullscreen");this._isFullscreen=true}},_handleEscKey:function(){if(!d.isFullScreen(this)&&!this._exitFired){this.fire("exitFullscreen");this._exitFired=true;this._isFullscreen=false}}});L.Map.addInitHook(function(){if(this.options.fullscreenControl){this.fullscreenControl=L.control.fullscreen(this.options.fullscreenControlOptions);this.addControl(this.fullscreenControl)}});L.control.fullscreen=function(e){return new L.Control.FullScreen(e)};var d={supportsFullScreen:false,isFullScreen:function(){return false},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},c="webkit moz o ms khtml".split(" ");if(typeof document.exitFullscreen!=="undefined"){d.supportsFullScreen=true}else{for(var b=0,a=c.length;b<a;b++){d.prefix=c[b];if(typeof document[d.prefix+"CancelFullScreen"]!=="undefined"){d.supportsFullScreen=true;break}}}if(d.supportsFullScreen){d.fullScreenEventName=d.prefix+"fullscreenchange";d.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}};d.requestFullScreen=function(e){return(this.prefix==="")?e.requestFullscreen():e[this.prefix+"RequestFullScreen"]()};d.cancelFullScreen=function(e){return(this.prefix==="")?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}}if(typeof jQuery!=="undefined"){jQuery.fn.requestFullScreen=function(){return this.each(function(){var e=jQuery(this);if(d.supportsFullScreen){d.requestFullScreen(e)}})}}window.fullScreenApi=d})();if(typeof require!=="undefined"){var $=require("jquery")}L.Control.IIP=L.Control.extend({options:{title:"a control related to IIPImage",collapsed:true,position:"topleft"},initialize:function(b,a){L.setOptions(this,a);this._className="leaflet-control-iip";this._id="leaflet-iipimage";this._layers=b},addTo:function(a){if(a._sidebar){this._sidebar=a;this._map=a._map;this._dialog=L.DomUtil.create("div",this._className+"-dialog");a.addTab(this._id,this._className,this.options.title,this._dialog,this._sideClass);this._map.on("layeradd",this._checkIIP,this);return a}else{return L.Control.prototype.addTo.call(this,a)}},onAdd:function(d){var c=this._className,e=this._id,b=this._container=L.DomUtil.create("div",c+" leaflet-bar");b.setAttribute("aria-haspopup",true);L.DomEvent.disableClickPropagation(b).disableScrollPropagation(b);this._dialog=L.DomUtil.create("div",c+"-dialog",b);if(this.options.collapsed){if(!L.Browser.android){L.DomEvent.on(b,"mouseover",this._expand,this).on(b,"mouseout",this._collapse,this)}var a=this._toggle=L.DomUtil.create("a",c+"-toggle leaflet-bar",b);a.href="#";a.id=e+"-toggle";a.title=this.options.title;if(L.Browser.touch){L.DomEvent.on(a,"click",L.DomEvent.stop).on(a,"click",this._expand,this)}else{L.DomEvent.on(a,"focus",this._expand,this)}this._map.on("click",this._collapse,this)}else{this._expand()}this._map.on("layeradd",this._checkIIP,this);return this._container},_checkIIP:function(b){var a=b.layer;if(!a||!a.iipdefault){return}this._layer=a;if(this._reloadFlag){a.once("load",this._resetDialog,this)}else{this._initDialog();this._reloadFlag=true}},_initDialog:function(){},_resetDialog:function(){this._dialog.innerHTML="";this._initDialog()},_addDialogBox:function(b){var a=L.DomUtil.create("div",this._className+"-box",this._dialog);if(b){a.id=b}return a},_addDialogLine:function(c,b){var a=L.DomUtil.create("div",this._className+"-line",b),d=L.DomUtil.create("div",this._className+"-label",a);d.innerHTML=c;return a},_addDialogElement:function(a){return L.DomUtil.create("div",this._className+"-element",a)},_expand:function(){L.DomUtil.addClass(this._container,this._className+"-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" "+this._className+"-expanded","")},getActiveBaseLayer:function(){return this._activeBaseLayer},_findActiveBaseLayer:function(){var c=this._layers;this._prelayer=undefined;for(var b in c){var a=c[b];if(!a.overlay){if(!a._map){this._prelayer=a}else{if(this._map.hasLayer(a)&&a.iipdefault){return a}}}}return undefined},_createButton:function(e,d,a,c,f){var b=L.DomUtil.create("a",e,d);b.target="_blank";if(a){b.id=e+"-"+a}if(c){L.DomEvent.on(b,"click touch",c,this)}if(f){b.title=f}return b},_createRadioButton:function(e,d,g,f,c,h){var b=L.DomUtil.create("input",e,d);b.type="radio";b.name=e;b.value=g;b.checked=f;if(c){L.DomEvent.on(b,"click touch",c,g)}var a=L.DomUtil.create("label",e,d);a.htmlFor=b.id=e+"-"+g;if(h){a.title=h}return b},_createSelectMenu:function(h,n,j,d,e,k,m){var a=L.DomUtil.create("div",h,n),l=L.DomUtil.create("select",h,a),c=document.createElement("option"),b=l.opt=[],g;c.text="choose";c.disabled=true;if(!e||e<0){c.selected=true}l.add(c,null);for(var f in j){g=parseInt(f,10);b[g]=document.createElement("option");b[g].text=j[g];b[g].value=g;if(d&&d[g]){b[g].disabled=true}else{if(g===e){b[g].selected=true}}l.add(b[g],null)}if(this._container&&!L.Browser.android&&this.options.collapsed){L.DomEvent.on(l,"mousedown",function(){L.DomEvent.off(this._container,"mouseout",this._collapse,this);this.collapsedOff=true},this);L.DomEvent.on(this._container,"mouseover",function(){if(this.collapsedOff){L.DomEvent.on(this._container,"mouseout",this._collapse,this);this.collapsedOff=false}},this)}if(k){L.DomEvent.on(l,"change keyup",k,this)}if(m){a.title=m}return l},_createColorPicker:function(d,h,b,a,f,e,g){var c=this,i=L.DomUtil.create("input",d,h);i.type="color";i.value=a;i.id=d+"-"+b;$(document).ready(function(){$(i).spectrum({showInput:true,appendTo:"#"+c._id,showPaletteOnly:true,togglePaletteOnly:true,localStorageKey:e,change:function(j){i.value=j.toHexString()}}).on("show.spectrum",function(){if(c._container){L.DomEvent.off(c._container,"mouseout",c._collapse)}});if(f){$(i).on("change",f)}if(g){$("#"+i.id+"+.sp-replacer").prop("title",g)}});return i},_addSwitchInput:function(e,d,h,f,g,a,i){var j=this._addDialogLine(h,d),b=this._addDialogElement(j),c=L.flipswitch(b,{checked:i,id:a,title:g});c.on("change",function(){this._onInputChange(e,f,c.value())},this);return b},_addNumericalInput:function(h,f,m,i,l,a,k,b,e,j,d){var n=this._addDialogLine(m,f),c=this._addDialogElement(n),g=c.spinbox=L.spinbox(c,{step:b,dmin:e,dmax:j,initValue:k,title:l});g.on("change",function(){L.IIPUtils.flashElement(g._input);this._onInputChange(h,i,g.value(),d)},this);return c},_spinboxStep:function(b,a){var c=parseFloat((Math.abs(a===b?a:a-b)*0.01).toPrecision(1));return c===0?1:c},_onInputChange:function(b,a,e,c){var d=a.split(/\[|\]/);if(d[1]){b[d[0]][parseInt(d[1],10)]=e}else{b[d[0]]=e}if(c){c(b)}b.redraw()},_updateLayerList:function(){if(!this._dialog){return this}if(this._layerList){L.DomUtil.empty(this._layerList)}else{this._layerList=L.DomUtil.create("div","leaflet-control-iip-layerlist",this._dialog)}for(var a in this._layers){this._addLayerItem(this._layers[a])}return this},_addLayerItem:function(e){var g=this,d=L.DomUtil.create("div","leaflet-control-iip-layer"),f=L.DomUtil.create("div","leaflet-control-iip-layerswitch",d);if(e.layer.notReady){L.DomUtil.create("div","leaflet-control-iip-activity",f)}else{var a,c=this._map.hasLayer(e.layer);a=document.createElement("input");a.type="checkbox";a.className="leaflet-control-iip-selector";a.defaultChecked=c;a.layerId=L.stamp(e.layer);L.DomEvent.on(a,"click",function(){var k,j,m,h=this._layerList.getElementsByTagName("input"),l=h.length;this._handlingClick=true;for(k=0;k<l;k++){j=h[k];if(!("layerId" in j)){continue}m=this._layers[j.layerId];if(j.checked&&!this._map.hasLayer(m.layer)){m.layer.addTo(this._map)}else{if(!j.checked&&this._map.hasLayer(m.layer)){this._map.removeLayer(m.layer)}}}this._handlingClick=false},this);f.appendChild(a)}var b=L.DomUtil.create("div","leaflet-control-iip-layername",d);b.innerHTML=" "+e.name;b.style.textShadow="0px 0px 5px "+e.layer.nameColor;this._createButton("leaflet-control-iip-trash",d,undefined,function(){g.removeLayer(e.layer);if(!e.notReady){g._map.removeLayer(e.layer)}},"Delete layer");this._layerList.appendChild(d);return d},addLayer:function(c,b,a){c.on("add remove",this._onLayerChange,this);var d=L.stamp(c);this._layers[d]={layer:c,name:b,index:a};return this._updateLayerList()},removeLayer:function(a){a.off("add remove",this._onLayerChange,this);a.fire("trash",{index:this._layers[L.stamp(a)].index});a.off("trash");delete this._layers[L.stamp(a)];return this._updateLayerList()},_onLayerChange:function(c){if(!this._handlingClick){this._updateLayerList()}var b=this._layers[L.stamp(c.target)],a=c.type==="add"?"overlayadd":"overlayremove";this._map.fire(a,b)}});L.control.iip=function(b,a){return new L.Control.IIP(b,a)};if(typeof require!=="undefined"){var $=require("jquery")}L.Control.IIP.Catalog=L.Control.IIP.extend({defaultCatalogs:[L.Catalog.GAIA_DR1,L.Catalog["2MASS"],L.Catalog.SDSS,L.Catalog.PPMXL,L.Catalog.Abell],options:{title:"Catalog overlays",collapsed:true,position:"topleft",nativeCelsys:true,color:"#FFFF00",timeOut:30,authenticate:false},initialize:function(b,a){L.setOptions(this,a);this._className="leaflet-control-iip";this._id="leaflet-iipcatalog";this._layers={};this._handlingClick=false;this._sideClass="catalog";this._catalogs=b?b:this.defaultCatalogs},_initDialog:function(){var c=this._className,f=this._catalogs,e=this._addDialogBox(),a=this._addDialogLine('<a id="logo-cds" href="http://cds.u-strasbg.fr">&nbsp;</a>',e),d=this._addDialogElement(a),g=this._createColorPicker(c+"-color",d,"catalog",this.options.color,false,"iipCatalog","Click to set catalog color");var b=this._createSelectMenu(this._className+"-select",d,f.map(function(h){return h.name}),undefined,-1,undefined,"Select Catalog");L.DomEvent.on(b,"change keyup",function(){b.title=f[b.selectedIndex-1].attribution},this);d=this._addDialogElement(a);this._createButton(c+"-button",d,"catalog",function(){var i=b.selectedIndex-1;if(i>=0){var h=f[i];h.color=g.value;b.selectedIndex=0;b.title="Select Catalog";this._getCatalog(h,this.options.timeOut)}},"Query catalog")},_resetDialog:function(){},_getCatalog:function(h,n){var i=this,d=this._map,g=d.options.crs,f=g.forceNativeCelsys&&!this.options.nativeCelsys,a=f?g.celsysToEq(d.getCenter()):d.getCenter(),o=d.getPixelBounds(),m=d.getZoom(),r=new L.LayerGroup(null);r.notReady=true;this.addLayer(r,h.name);if(h.authenticate){this.options.authenticate=h.authenticate}var p=Math.abs(Math.cos(a.lat*Math.PI/180)),l=f?[g.celsysToEq(d.unproject(o.min,m)),g.celsysToEq(d.unproject(L.point(o.min.x,o.max.y),m)),g.celsysToEq(d.unproject(o.max,m)),g.celsysToEq(d.unproject(L.point(o.max.x,o.min.y),m))]:[d.unproject(o.min,m),d.unproject(L.point(o.min.x,o.max.y),m),d.unproject(o.max,m),d.unproject(L.point(o.max.x,o.min.y),m)],q;if(g.forceNativeCelsys&&this.options.nativeCelsys){switch(g.celsyscode){case"ecliptic":q="E2000.0";break;case"galactic":q="G";break;case"supergalactic":q="S";break;default:q="J2000.0";break}}else{q="J2000.0"}if(h.regionType==="box"){var k=(Math.max(g._deltaLng(l[0],a),g._deltaLng(l[1],a),g._deltaLng(l[2],a),g._deltaLng(l[3],a))-Math.min(g._deltaLng(l[0],a),g._deltaLng(l[1],a),g._deltaLng(l[2],a),g._deltaLng(l[3],a)))*p,j=Math.max(l[0].lat,l[1].lat,l[2].lat,l[3].lat)-Math.min(l[0].lat,l[1].lat,l[2].lat,l[3].lat);if(j<0.0001){j=0.0001}if(k<0.0001){k=0.0001}L.IIPUtils.requestURL(L.Util.template(h.url,L.extend({sys:q,lng:a.lng.toFixed(6),lat:a.lat.toFixed(6),dlng:k.toFixed(4),dlat:j.toFixed(4),nmax:h.nmax+1,maglim:h.maglim})),"getting "+h.service+" data",function(c,b){i._loadCatalog(h,r,c,b)},this,n)}else{var e=Math.max(g.distance(l[0],a),g.distance(l[0],a),g.distance(l[0],a),g.distance(l[0],a));L.IIPUtils.requestURL(L.Util.template(h.url,L.extend({sys:q,lng:a.lng.toFixed(6),lat:a.lat.toFixed(6),dr:e.toFixed(4),nmax:h.nmax+1})),"querying "+h.service+" data",function(c,b){i._loadCatalog(h,r,c,b)},this,this.options.timeOut)}},_loadCatalog:function(g,i,h,e){if(e.readyState===4){if(e.status===200){var f=h._map.options.crs,a=e.responseText,c=g.toGeoJSON(a),d=L.geoJson(c,{onEachFeature:function(k,j){if(k.properties&&k.properties.items){j.bindPopup(g.popup(k))}},coordsToLatLng:function(k){if(f.forceNativeCelsys){var j=f.eqToCelsys(L.latLng(k[1],k[0]));return new L.LatLng(j.lat,j.lng,k[2])}else{return new L.LatLng(k[1],k[0],k[2])}},pointToLayer:function(j,k){return g.draw(j,k)},style:function(j){return{color:g.color,weight:2}}}),b;d.nameColor=g.color;d.addTo(h._map);this.removeLayer(i);if(c.features.length>g.nmax){c.features.pop();b=true}this.addLayer(d,g.name+" ("+c.features.length.toString()+(b?"+ entries)":" entries)"));if(b){alert("Selected area is too large: "+g.name+" sample has been truncated to the first "+g.nmax+" sources.")}}else{if(e.status!==0){alert("Error "+e.status+" while querying "+g.service+".")}this.removeLayer(i)}}}});L.control.iip.catalog=function(b,a){return new L.Control.IIP.Catalog(b,a)};if(typeof require!=="undefined"){var $=require("jquery")}L.Control.IIP.Channel=L.Control.IIP.extend({options:{title:"Channel mixing",collapsed:true,cMap:"grey",mixingMode:null,position:"topleft",},initialize:function(b,a){L.setOptions(this,a);this._className="leaflet-control-iip";this._id="leaflet-iipchannel";this._sideClass="channel";this._settings=[]},saveSettings:function(a,e){if(!this._settings[e]){this._settings[e]={}}var b=this._settings[e],d=a.iipNChannel;b.channel=a.iipChannel;b.cMap=a.iipCMap;b.rgb=[];for(var f=0;f<d;f++){b.rgb[f]=a.iipRGB[f].clone()}},loadSettings:function(a,e){var b=this._settings[e],d=a.iipNChannel;if(!b){return}a.iipChannel=b.channel;a.iipCMap=b.cMap;for(var f=0;f<d;f++){a.iipRGB[f]=b.rgb[f].clone()}},_initDialog:function(){var f=this,e=this._layer,g=this._className,h=this._dialog;this.saveSettings(e,"mono");this.saveSettings(e,"color");this._mode=this.options.mixingMode?this.options.mixingMode:e.iipMode;var c=this._addDialogBox(),d=this._addDialogLine("Mode:",c),i=this._addDialogElement(d),b=L.DomUtil.create("div",g+"-radios",i),a,j;j=this._createRadioButton(g+"-radio",b,"mono",(this._mode==="mono"),function(){f.saveSettings(e,f._mode);for(a=c.lastChild;a!==d;a=c.lastChild){c.removeChild(a)}for(a=h.lastChild;a!==c;a=h.lastChild){h.removeChild(a)}f._channelList=undefined;f.loadSettings(e,"mono");f._initMonoDialog(e,c);f._mode="mono"},"Select mono-channel palettized mode");j=this._createRadioButton(g+"-radio",b,"color",(this._mode!=="mono"),function(){f.saveSettings(e,f._mode);for(a=c.lastChild;a!==d;a=c.lastChild){c.removeChild(a)}for(a=h.lastChild;a!==c;a=h.lastChild){h.removeChild(a)}f.loadSettings(e,"color");f._channelList=undefined;f._initColorDialog(e,c);f._updateChannelList(e);f._mode="color"},"Select color mixing mode");if(f._mode==="mono"){f._initMonoDialog(e,c)}else{f._initColorDialog(e,c);f._updateChannelList(e)}},_initMonoDialog:function(h,f){var j=this,g=h.iipChannelLabels,k=this._className,m=this._addDialogLine("Channel:",f),d=this._addDialogElement(m);h.updateMono();this._chanSelect=this._createSelectMenu(this._className+"-select",d,h.iipChannelLabels,undefined,h.iipChannel,function(){h.iipChannel=parseInt(this._chanSelect.selectedIndex-1,10);this._updateChannel(h,h.iipChannel);h.redraw()},"Select image channel");m=this._addDialogLine("LUT:",f);d=this._addDialogElement(m);var l=L.DomUtil.create("div",k+"-cmaps",d),b=[],a=["grey","jet","cold","hot"],c=function(){j._onInputChange(h,"iipCMap",this)},e;for(e in a){b[e]=this._createRadioButton("leaflet-cmap",l,a[e],(a[e]===this.options.cMap),c,'"'+a[e].charAt(0).toUpperCase()+a[e].substr(1)+'" color-map')}this._addMinMax(h,h.iipChannel,f);h.redraw()},_initColorDialog:function(b,e){var g=this,c=this._className,a=this._addDialogLine("Channel:",e),d=this._addDialogElement(a),f=this._chanColPick=this._createColorPicker(c+"-color",d,"channel",b.iipRGB[b.iipChannel].toStr(),function(){var i=b.iipChannel,h=$(f).val();g._updateMix(b,i,L.rgb(h));g.collapsedOff=true},"iipChannel","Click to set channel color");this._onInputChange(b,"iipCMap","grey");b.updateMix();this._chanSelect=this._createSelectMenu(this._className+"-select",d,b.iipChannelLabels,undefined,b.iipChannel,function(){b.iipChannel=this._chanSelect.selectedIndex-1;this._updateChannel(b,b.iipChannel,f)},"Select image channel");this._addMinMax(b,b.iipChannel,e);b.redraw()},_addMinMax:function(a,d,c){var b=this._spinboxStep(a.iipMinValue[d],a.iipMaxValue[d]);this._minElem=this._addNumericalInput(a,c,"Min:","iipMinValue["+d+"]","Lower clipping limit in "+a.iipChannelUnits[d]+".","leaflet-channel-minvalue",a.iipMinValue[d],b);this._maxElem=this._addNumericalInput(a,c,"Max:","iipMaxValue["+d+"]","Upper clipping limit in "+a.iipChannelUnits[d]+".","leaflet-channel-maxvalue",a.iipMaxValue[d],b)},_updateChannel:function(b,d,a){var e=this,c=this._spinboxStep(b.iipMinValue[d],b.iipMaxValue[d]);e._chanSelect.selectedIndex=d+1;if(a){$(a).spectrum("set",b.iipRGB[d].toStr());$(a).val(b.iipRGB[d].toStr()).off("change").on("change",function(){e._updateMix(b,d,L.rgb($(a).val()))})}this._minElem.spinbox.value(b.iipMinValue[d]).step(c).off("change").on("change",function(){e._onInputChange(b,"iipMinValue["+d+"]",e._minElem.spinbox.value())},this);this._maxElem.spinbox.value(b.iipMaxValue[d]).step(c).off("change").on("change",function(){e._onInputChange(b,"iipMaxValue["+d+"]",e._maxElem.spinbox.value())},this)},_updateMix:function(b,c,a){b.rgbToMix(c,a);this._updateChannelList(b);b.redraw()},_updateChannelList:function(g){var h=g.iipChannelLabels,k=this._channelList,e=this._channelElems,m=this._trashElems,f,a,j,d,l,i,b;if(k){L.DomUtil.empty(this._channelList)}else{k=this._channelList=L.DomUtil.create("div",this._className+"-chanlist",this._dialog)}e=this._channelElems=[];m=this._trashElems=[];for(i in h){b=parseInt(i,10);j=g.iipRGB[b];if(j.isOn()){f=L.DomUtil.create("div",this._className+"-channel",k);d=L.DomUtil.create("div",this._className+"-chancolor",f);d.style.backgroundColor=j.toStr();this._activateChanElem(d,g,b);l=L.DomUtil.create("div",this._className+"-chanlabel",f);l.innerHTML=h[i];this._activateChanElem(l,g,b);a=this._createButton("leaflet-control-iip-trash",f,undefined,undefined,"Delete channel");this._activateTrashElem(a,g,b);e.push(f);m.push(a)}}},_activateTrashElem:function(b,a,c){L.DomEvent.on(b,"click touch",function(){this._updateMix(a,c,L.rgb(0,0,0));if(a===this._layer&&c===a.iipChannel){$(this._chanColPick).spectrum("set",a.iipRGB[c].toStr());$(this._chanColPick).val(a.iipRGB[c].toStr())}},this)},_activateChanElem:function(c,a,b){L.DomEvent.on(c,"click touch",function(){this._updateChannel(a,b,this._chanColPick)},this)}});L.control.iip.channel=function(a){return new L.Control.IIP.Channel(a)};if(typeof require!=="undefined"){var $=require("jquery")}L.Control.IIP.Doc=L.Control.IIP.extend({options:{title:"Documentation",collapsed:true,position:"topleft",pdflink:undefined},initialize:function(b,a){L.setOptions(this,a);this._className="leaflet-control-iip";this._id="leaflet-iipdoc";this._sideClass="doc";this._url=b},_initDialog:function(){var g=this,h=this._className,f=this._layer,a=L.DomUtil.create("div",this._className+"-framebox",this._dialog),d=this._iframe=L.DomUtil.create("iframe",this._className+"-doc",a);d.src=this._url;d.frameborder=0;this._navHistory=[];this._navPos=0;this._ignore=false;L.DomEvent.on(d,"load hashchange",this._onloadNav,this);var e=this._addDialogBox("leaflet-iipdoc-dialog"),i=this._addDialogLine("Navigate:",e),b=this._addDialogElement(i);this._homeButton=this._createButton(h+"-button",b,"home",this._homeNav,"Navigate home");this._backButton=this._createButton(h+"-button",b,"back",this._backNav,"Navigate backward");this._forwardButton=this._createButton(h+"-button",b,"forward",this._forwardNav,"Navigate forward");if(this.options.pdflink){var c=this._createButton(h+"-button",b,"pdf",undefined,"Download PDF version");c.href=this.options.pdflink}},_updateNav:function(a){if(a!==this._navPos){this._navPos=a;this._navIgnore=true;this._iframe.src=this._navHistory[this._navPos-1];this._disableNav()}},_disableNav:function(){this._backButton.disabled=(this._navPos===1);this._forwardButton.disabled=(this._navPos>=this._navHistory.length)},_backNav:function(){if(!this._backButton.disabled){this._updateNav(Math.max(1,this._navPos-1))}},_forwardNav:function(){if(!this._forwardButton.disabled){this._updateNav(Math.min(this._navHistory.length,this._navPos+1))}},_homeNav:function(){if(!this._backButton.disabled){this._updateNav(1)}},_onloadNav:function(){if(true){var a=this._iframe.contentDocument.getElementsByTagName("a");for(var c=0;c<a.length;c++){if(L.IIPUtils.isExternal(a[c].href)){a[c].setAttribute("target","_blank")}}this._iframeLoad1=true}if(!this._navIgnore){var b=this._iframe.contentWindow.location.href;if(b!==this._navHistory[this._navPos-1]){this._navHistory.splice(this._navPos,this._navHistory.length-this._navPos);this._navHistory.push(b);this._navPos=this._navHistory.length;this._disableNav()}}else{this._navIgnore=false}}});L.control.iip.doc=function(b,a){return new L.Control.IIP.Doc(b,a)};if(typeof require!=="undefined"){var $=require("jquery")}L.Control.IIP.Image=L.Control.IIP.extend({options:{title:"Image preferences",collapsed:true,position:"topleft"},initialize:function(a){L.setOptions(this,a);this._className="leaflet-control-iip";this._id="leaflet-iipimage";this._sideClass="image"},_initDialog:function(){var d=this,b=this._className,a=this._layer,c;this._addSwitchInput(a,this._dialog,"Invert:","iipInvertCMap","Invert color map(s)","leaflet-invertCMap",a.iipInvertCMap);this._addNumericalInput(a,this._dialog,"Contrast:","iipContrast","Adjust Contrast. 1.0: normal.","leaflet-contrastValue",a.iipContrast,0.05,0,10);this._addNumericalInput(a,this._dialog,"Color Sat.:","iipColorSat","Adjust Color Saturation. 0: B&W, 1.0: normal.","leaflet-colorsatvalue",a.iipColorSat,0.05,0,5,this._updateMix);this._addNumericalInput(a,this._dialog,"Gamma:","iipGamma","Adjust Gamma correction. The standard value is 2.2.","leaflet-gammavalue",a.iipGamma,0.05,0.5,5);this._addNumericalInput(a,this._dialog,"JPEG quality:","iipQuality","Adjust JPEG compression quality. 1: lowest, 100: highest","leaflet-qualvalue",a.iipQuality,1,1,100)},_updateMix:function(a){var b=a.iipNChannel;for(var d=0;d<b;d++){a.rgbToMix(d)}return}});L.control.iip.image=function(a){return new L.Control.IIP.Image(a)};if(typeof require!=="undefined"){var $=require("jquery")}L.Control.IIP.Profile=L.Control.IIP.extend({options:{title:"Profile overlays",collapsed:true,position:"topleft",profile:true,profileColor:"#FF00FF",spectrum:true,spectrumColor:"#A000FF"},initialize:function(a){L.setOptions(this,a);this._className="leaflet-control-iip";this._id="leaflet-iipprofile";this._layers={};this._sideClass="profile";this._handlingClick=false},_initDialog:function(){var h=this,c=this.options,e=this._className,g=this._addDialogBox(),b,f;if(c.profile){b=this._addDialogLine("Profile:",g);f=this._addDialogElement(b);var a=this._createColorPicker(e+"-color",f,"profile",c.profileColor,false,"iipProfile","Click to set line color");this._createButton(e+"-button",f,"start",function(){if(this._currProfileLine){this._updateLine()}else{var k=h._map,i=k.getCenter(),j=this._currProfileLine=L.polyline([i,i],{color:a.value,weight:7,opacity:0.5});j.nameColor=a.value;j.addTo(k);k.on("drag",this._updateLine,this)}},"Start drawing a profile line");this._createButton(e+"-button",f,"end",this._profileEnd,"End line and plot")}if(c.spectrum){b=this._addDialogLine("Spectrum:",g);f=this._addDialogElement(b);var d=this._createColorPicker(e+"-color",f,"spectrum",c.spectrumColor,false,"iipSpectra","Click to set marker color");this._createButton(e+"-button",f,"spectrum",function(){var o=h._map,l=o.getCenter(),k=o.options.crs.options.nzoom-1,i=o.project(l,k).round(),n=o.unproject(i,k),j=this._spectrumMarker=L.circleMarker(n,{color:d.value,radius:6,title:"Spectrum"}).addTo(o),p=L.DomUtil.create("div",this._className+"-popup"),m=L.DomUtil.create("div",this._className+"-activity",p);p.id="leaflet-spectrum-plot";j.bindPopup(p,{minWidth:16,maxWidth:1024,closeOnClick:false}).openPopup();L.IIPUtils.requestURL(this._layer._url.replace(/\&.*$/g,"")+"&PFL="+k.toString()+":"+i.x.toFixed(0)+","+i.y.toFixed(0)+"-"+i.x.toFixed(0)+","+i.y.toFixed(0),"getting IIP layer spectrum",this._plotSpectrum,this)},"Plot a spectrum at the current map position")}},_updateLine:function(h){var g=this._map,d=g.getCenter(),b=g.options.crs.options.nzoom-1,f=this._currProfileLine.getLatLngs(),c=g.project(f[0],b),a=g.project(g.getCenter(),b);if(Math.abs(c.x-a.x)>Math.abs(c.y-a.y)){a.y=c.y}else{a.x=c.x}f[1]=g.unproject(a,b);this._currProfileLine.redraw()},_profileEnd:function(){var a=this._map,h=a.getCenter(),k=this._profileLine=this._currProfileLine;a.off("drag",this._updateLine,this);this._currProfileLine=undefined;var c=L.DomUtil.create("div",this._className+"-popup"),b=L.DomUtil.create("div",this._className+"-activity",c);c.id="leaflet-profile-plot";k.bindPopup(c,{minWidth:16,maxWidth:1024,closeOnClick:false}).openPopup();var i=a.options.crs.options.nzoom-1,j=k.getLatLngs(),f=a.project(j[0],i),d=a.project(j[1],i),g,e;if(d.x<f.x){g=d.x;d.x=f.x;f.x=g}if(d.y<f.y){e=d.y;d.y=f.y;f.y=e}L.IIPUtils.requestURL(this._layer._url.replace(/\&.*$/g,"")+"&PFL="+i.toString()+":"+f.x.toFixed(0)+","+f.y.toFixed(0)+"-"+d.x.toFixed(0)+","+d.y.toFixed(0),"getting IIP layer profile",this._plotProfile,this)},_getMeasurementString:function(){var b=this._currentLatLng,a=this._markers[this._markers.length-1].getLatLng(),e,d,c;e=this._measurementRunningTotal+L.IIPUtils.distance(b,a);if(e>=1){c="&#176;"}else{e*=60;if(e>=1){c="&#39;"}else{e*=60;c="&#34;"}}d=e.toFixed(2)+c;return d},_plotProfile:function(l,c){if(c.readyState===4){if(c.status===200){var k=JSON.parse(c.responseText),i=k.profile,e=l._layer,m=l._profileLine,f=document.getElementById("leaflet-profile-plot"),d=[],b=[],h,j;l.addLayer(m,"Image profile");if(e.iipMode==="mono"){d.push(l._extractProfile(e,i,e.iipChannel));b.push({color:"black",});h="Image profile for "+e.iipChannelLabels[e.iipChannel];j="Pixel value in "+e.iipChannelUnits[e.iipChannel]}else{var g=e.iipRGB;for(var a=0;a<e.iipNChannel;a++){if(g[a].isOn()){d.push(l._extractProfile(e,i,a));b.push({color:g[a].toStr(),label:e.iipChannelLabels[a]})}}h="Image profiles";j="Pixel value"}$(document).ready(function(){$.jqplot.config.enablePlugins=true;$.jqplot("leaflet-profile-plot",d,{title:h,grid:{backgroundColor:"#ddd",gridLineColor:"#eee"},axes:{xaxis:{label:"position along line",labelRenderer:$.jqplot.CanvasAxisLabelRenderer,pad:1},yaxis:{label:j,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,pad:1}},legend:{show:(e.iipMode!=="mono"),location:"ne",},highlighter:{show:true,sizeAdjust:2,tooltipLocation:"n",tooltipAxes:"y",tooltipFormatString:"%.6g "+e.iipChannelUnits[e.iipChannel],useAxesFormatters:false,bringSeriesToFront:true},cursor:{show:true,zoom:true},series:b,seriesDefaults:{lineWidth:2,showMarker:false}})});f.removeChild(f.childNodes[0]);m._popup.update()}}},_extractProfile:function(d,c,f){var g=[],e=d.iipNChannel,b=c.length/e;for(var a=0;a<b;a++){g.push(c[a*e+f])}return g},_plotSpectrum:function(l,c){if(c.readyState===4){if(c.status===200){var k=JSON.parse(c.responseText),h=k.profile,e=l._layer,d=l._spectrumMarker,f=document.getElementById("leaflet-spectrum-plot"),j=[],b=[],g,i;l.addLayer(d,"Image spectrum");for(var a=0;a<e.iipNChannel;a++){j.push([e.iipChannelLabels[a],l._extractAverage(e,h,a)])}g="Image Spectrum";i="Average pixel value";$(document).ready(function(){$.jqplot.config.enablePlugins=true;$.jqplot("leaflet-spectrum-plot",[j],{title:g,grid:{backgroundColor:"#F0F0F0",gridLineColor:"#F8F8F8"},axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:-30,fontSize:"6pt"}},yaxis:{label:i,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,}},highlighter:{show:true,sizeAdjust:2,tooltipLocation:"n",tooltipAxes:"y",tooltipFormatString:"%.6g "+e.iipChannelUnits[e.iipChannel],useAxesFormatters:false},cursor:{show:true,zoom:true},seriesDefaults:{lineWidth:2,showMarker:false}})});f.removeChild(f.childNodes[0]);d._popup.update()}}},_extractAverage:function(d,c,f){var e=d.iipNChannel,b=c.length/e,g=0;if(b===0){return 0}for(var a=0;a<b;a++){g+=c[a*e+f]}return g/b}});L.control.iip.profile=function(a){return new L.Control.IIP.Profile(a)};L.Control.IIP.Region=L.Control.IIP.extend({options:{title:"Region overlays",collapsed:true,position:"topleft",nativeCelsys:true,color:"#00FFFF",timeOut:30},initialize:function(b,a){L.setOptions(this,a);this._className="leaflet-control-iip";this._id="leaflet-iipregion";this._layers={};this._handlingClick=false;this._sideClass="region";this._regions=b&&b[0]?b:[]},_initDialog:function(){var e=this._className,b=this._regions,c=this._addDialogBox(),i=this._addDialogLine("Regions:",c),a=this._addDialogElement(i),h=this._createColorPicker(e+"-color",a,"region",this.options.color,false,"iipRegion","Click to set region color");var g=this._regionSelect=this._createSelectMenu(this._className+"-select",a,b.map(function(j){return j.name}),b.map(function(j){return(j.load?true:false)}),-1,undefined,"Select region");a=this._addDialogElement(i);this._createButton(e+"-button",a,"region",function(){var j=g.selectedIndex-1;if(j>=0){var k=this._regions[j];k.color=h.value;g.selectedIndex=0;g.opt[j].disabled=true;this._getRegion(k,this.options.timeOut)}},"Display region");var f;for(var d=0;d<b.length;d++){f=b[d];f.index=d;if(f.load===true){if(!f.color){f.color=this.options.color}this._getRegion(b[d],this.options.timeOut)}}},_resetDialog:function(){},_getRegion:function(f,d){var g=this,e=this._map,a=e.options.crs,c=a.forceNativeCelsys&&!this.options.nativeCelsys,b=new L.LayerGroup(null);b.notReady=true;this.addLayer(b,f.name);L.IIPUtils.requestURL(f.url,"loading "+f.name+" data",function(i,h){g._loadRegion(f,b,i,h)},this,this.options.timeOut)},_loadRegion:function(f,e,g,d){if(d.readyState===4){if(d.status===200){var b=g._map.options.crs,a=d.responseText,c=L.geoJson(JSON.parse(a),{onEachFeature:function(i,h){if(i.properties&&i.properties.description){h.bindPopup(i.properties.description)}else{if(f.description){h.bindPopup(f.description)}}},coordsToLatLng:function(i){if(b.forceNativeCelsys){var h=b.eqToCelsys(L.latLng(i[1],i[0]));return new L.LatLng(h.lat,h.lng,i[2])}else{return new L.LatLng(i[1],i[0],i[2])}},style:function(h){return{color:f.color,weight:2}}});c.nameColor=f.color;c.addTo(g._map);g.removeLayer(e);g.addLayer(c,f.name,f.index);L.DomEvent.on(c,"trash",function(h){if(h.index||h.index===0){g._regionSelect.opt[h.index].disabled=false}},g)}else{if(d.status!==0){alert("Error "+d.status+" while downloading "+f.url+".")}g.removeLayer(e);g._regionSelect.opt[f.index].disabled=false}}}});L.control.iip.region=function(b,a){return new L.Control.IIP.Region(b,a)};if(typeof require!=="undefined"){var $=require("jquery-browser")}L.Control.Layers.IIP=L.Control.Layers.extend({options:{title:"overlay menu",collapsed:true,position:"topright",autoZIndex:true,fileMenu:false,fileURL:"/fcgi-bin/iipsrv.fcgi?FIF=",fileRoot:"",fileTreeScript:"visiomatic/dist/filetree.php",fileProcessScript:"visiomatic/dist/processfits.php"},onAdd:function(a){a._layerControl=this;this._initLayout();this._update();return this._container},_initLayout:function(){var b="leaflet-control-layers",a=this._container=L.DomUtil.create("div",b);a.setAttribute("aria-haspopup",true);if(!L.Browser.touch){L.DomEvent.disableClickPropagation(a).disableScrollPropagation(a)}else{L.DomEvent.on(a,"click",L.DomEvent.stopPropagation)}var d=this._form=L.DomUtil.create("form",b+"-list");if(this.options.collapsed){if(!L.Browser.android){L.DomEvent.on(a,{mouseover:this._expand,mouseout:this._collapse},this)}var c=this._layersLink=L.DomUtil.create("a",b+"-toggle",a);c.href="#";c.title="Layers";if(L.Browser.touch){L.DomEvent.on(c,"click",L.DomEvent.stop).on(c,"click",this._expand,this)}else{L.DomEvent.on(c,"focus",this._expand,this)}L.DomEvent.on(d,"click",function(){setTimeout(L.bind(this._onInputClick,this),0)},this);this._map.on("click",this._collapse,this)}else{this._expand()}this._baseLayersList=L.DomUtil.create("div",b+"-base",d);if(this.options.fileMenu){var e=this._addButton=L.DomUtil.create("input",b+"-add",d);e.type="button";e.value="Add...";L.DomEvent.on(e,"click",this._openFileMenu,this)}this._separator=L.DomUtil.create("div",b+"-separator",d);this._overlaysList=L.DomUtil.create("div",b+"-overlays",d);a.appendChild(d)},_addItem:function(c){var d=this,i=L.DomUtil.create("div","leaflet-control-layers-item"),h=L.DomUtil.create("div","leaflet-control-layers-select",i);if(c.layer.notReady){L.DomUtil.create("div","leaflet-control-activity",h)}else{var f,g=this._map.hasLayer(c.layer);if(c.overlay){f=document.createElement("input");f.type="checkbox";f.className="leaflet-control-layers-selector";f.defaultChecked=g}else{f=this._createRadioElement("leaflet-base-layers",g)}f.layerId=L.stamp(c.layer);L.DomEvent.on(f,"click",this._onInputClick,this);h.appendChild(f)}var b=L.DomUtil.create("div","leaflet-control-layers-name",i);b.innerHTML=" "+c.name;b.style.textShadow="0px 0px 5px "+c.layer.nameColor;var e=L.DomUtil.create("input","leaflet-control-layers-trash",i);e.type="button";L.DomEvent.on(e,"click",function(){d.removeLayer(c.layer);if(!c.notReady){d._map.removeLayer(c.layer)}},this);var a=c.overlay?this._overlaysList:this._baseLayersList;a.appendChild(i);return i},_onInputClick:function(){var c,b,e,a=this._form.getElementsByTagName("input"),d=a.length;this._handlingClick=true;for(c=0;c<d;c++){b=a[c];if(!("layerId" in b)){continue}e=this._layers[b.layerId];if(b.checked&&!this._map.hasLayer(e.layer)){e.layer.addTo(this._map)}else{if(!b.checked&&this._map.hasLayer(e.layer)){this._map.removeLayer(e.layer)}}}this._handlingClick=false},_addDialogLine:function(a,b){var c=L.DomUtil.create("div",this._className+"-element",b),d=L.DomUtil.create("span",this._className+"-label",c);d.innerHTML=a;return c},_openFileMenu:function(){var c=this,a=L.DomUtil.create("div","leaflet-control-filemenu",this._map._controlContainer);a.title="Open file";this._addButton.disabled=true;L.DomEvent.disableClickPropagation(a).disableScrollPropagation(a);$(".leaflet-control-filemenu").dialog({appendTo:"body",close:function(d,e){L.DomUtil.remove(a);c._addButton.disabled=false},show:{effect:"clip",duration:250},hide:{effect:"clip",duration:250},height:200});var b=L.DomUtil.create("div","leaflet-control-filetree",a);b.id="leaflet-filetree";$(document).ready(function(){$("#leaflet-filetree").fileTree({root:c.options.fileRoot,script:c.options.fileTreeScript},function(e){var f=c._map._layerControl,d=e.replace(/(^.*\/|\..*$)/g,""),g;if(f){g=new L.LayerGroup(null);g.notReady=true;f.addBaseLayer(g,"converting "+d+"...");if(f.options.collapsed){f._expand()}}$.post(c.options.fileProcessScript,{fitsname:e},function(i){i=i.trim();var h=L.tileLayer.iip(c.options.fileURL+i,{title:d});if(h.iipMetaReady){c._updateBaseLayer(g,h)}else{h.once("metaload",function(){c._updateBaseLayer(g,h)})}})})})},_updateBaseLayer:function(c,b){var d=this._map,a=d._layerControl;a.removeLayer(c);d.eachLayer(d.removeLayer);b.addTo(d);a.addBaseLayer(b,b._title);d.fire("baselayerchange");if(a.options.collapsed){a._collapse()}}});L.control.layers.iip=function(c,b,a){return new L.Control.Layers.IIP(c,b,a)};L.Control.Reticle=L.Control.extend({options:{position:"bottomleft"},onAdd:function(d){var b=this._reticle=L.DomUtil.create("div","leaflet-reticle",this._map._controlContainer),c=b.style;c.position="absolute";c.left="50%";c.bottom="50%";c.textAlign="center";c.verticalAlign="middle";c.pointerEvents="none";b.innerHTML="";var a=this._container=L.DomUtil.create("div","leaflet-dummy");return a},onRemove:function(a){this._reticle.parentNode.removeChild(this._reticle)}});L.control.reticle=function(a){return new L.Control.Reticle(a)};L.Control.Scale.WCS=L.Control.Scale.extend({options:{position:"bottomleft",title:"Scale",maxWidth:128,metric:false,imperial:false,degrees:true,pixels:true,custom:false,customScale:1,customUnits:"",planetRadius:6378137,updateWhenIdle:false},_addScales:function(b,c,a){if(b.metric){this._mScale=L.DomUtil.create("div",c,a);this._mScale.title=b.metricTitle?b.metricTitle:b.title}if(b.imperial){this._iScale=L.DomUtil.create("div",c,a);this._iScale.title=b.imperialTitle?b.imperialTitle:b.title}if(b.degrees){this._dScale=L.DomUtil.create("div",c,a);this._dScale.title=b.degreesTitle?b.degreesTitle:b.title}if(b.pixels){this._pScale=L.DomUtil.create("div",c,a);this._pScale.title=b.pixelsTitle?b.pixelsTitle:b.title}if(b.custom){this._cScale=L.DomUtil.create("div",c,a);this._cScale.title=b.customTitle?b.customTitle:b.title}this.angular=b.metric||b.imperial||b.degrees},_update:function(){var i=this.options,b=this._map,g=b.options.crs;if(i.pixels&&g.options&&g.options.nzoom){var f=Math.pow(2,g.options.nzoom-1-b.getZoom());this._updatePixels(f*i.maxWidth)}if(i.custom&&g.options&&g.options.nzoom){var h=Math.pow(2,g.options.nzoom-1-b.getZoom())*i.customScale;this._updateCustom(h*i.maxWidth,i.customUnits)}if(this.angular){var a=b.getCenter(),d=Math.cos(a.lat*Math.PI/180),e=Math.sqrt(this._jacobian(a))*d,c=e*i.maxWidth;if(i.metric){this._updateMetric(c*Math.PI/180*i.planetRadius)}if(i.imperial){this._updateImperial(c*Math.PI/180*i.planetRadius)}if(i.degrees){this._updateDegrees(c)}}},_jacobian:function(e){var c=this._map,d=c.project(e),b=c.unproject(d.add([10,0])),a=c.unproject(d.add([0,10]));return 0.01*Math.abs((b.lng-e.lng)*(a.lat-e.lat)-(a.lng-e.lng)*(b.lat-e.lat))},_updateCustom:function(d,h){var b=this._cScale;if(d>1000000000){var i=d*1e-9,j=this._getRoundNum(i);this._updateScale(b,j+" G"+h,j/i)}else{if(d>1000000){var a=d*0.000001,e=this._getRoundNum(a);this._updateScale(b,e+" M"+h,e/a)}else{if(d>1000){var c=d*0.001,g=this._getRoundNum(c);this._updateScale(b,g+" k"+h,g/c)}else{var f=this._getRoundNum(d);this._updateScale(b,f+" "+h,f/d)}}}},_updatePixels:function(d){var g=this._pScale;if(d>1000000){var f=d*0.000001,a=this._getRoundNum(f);this._updateScale(g,a+" Mpx",a/f)}else{if(d>1000){var c=d*0.001,e=this._getRoundNum(c);this._updateScale(g,e+" kpx",e/c)}else{var b=this._getRoundNum(d);this._updateScale(g,b+" px",b/d)}}},_updateDegrees:function(a){var g=a*3600,c=this._dScale;if(g<1){var f=g*1000,i=this._getRoundNum(f);this._updateScale(c,i+" mas",i/f)}else{if(g<60){var h=this._getRoundNum(g);this._updateScale(c,h+" &#34;",h/g)}else{if(g<3600){var d=a*60,e=this._getRoundNum(d);this._updateScale(c,e+" &#39;",e/d)}else{var b=this._getRoundNum(a);this._updateScale(c,b+" &#176;",b/a)}}}}});L.control.scale.wcs=function(a){return new L.Control.Scale.WCS(a)};L.Control.Sidebar=L.Control.extend({includes:L.Mixin.Events,options:{position:"left",title:"Toggle advanced menu",collapsed:true,forceSeparateButton:false},initialize:function(a){var b,c;L.setOptions(this,a);this._sidebar=L.DomUtil.create("div","leaflet-container sidebar");if(this.options.collapsed){L.DomUtil.addClass(this._sidebar,"collapsed")}else{L.DomUtil.addClass(this._sidebar,"closed")}L.DomUtil.addClass(this._sidebar,"sidebar-"+this.options.position);if(L.Browser.touch){L.DomUtil.addClass(this._sidebar,"leaflet-touch")}this._tabs=L.DomUtil.create("div","sidebar-tabs",this._sidebar);this._tabitems=[];this._container=L.DomUtil.create("div","sidebar-content",this._sidebar);this._panes=[];this._closeButtons=[]},addTo:function(d){var c="leaflet-control-zoom-sidebar",b=d._controlContainer,a;L.DomUtil.addClass(d._container,"sidebar-map");b.insertBefore(this._sidebar,b.firstChild);L.DomEvent.disableClickPropagation(this._sidebar).disableScrollPropagation(this._sidebar);this._map=d;if(d.zoomControl&&!this.options.forceSeparateButton){a=d.zoomControl._container}else{a=L.DomUtil.create("div","leaflet-bar")}this._toggleButton=this._createButton(this.options.title,c+(this.options.collapsed?" collapsed":""),a);return this},addTabList:function(){this._tablist=L.DomUtil.create("ul","",this._tabs);this._tablist.setAttribute("role","tablist");return this._tablist},addTab:function(b,j,h,g,d){var i=this._tablist?this._tablist:this.addTabList(),k=L.DomUtil.create("li","",i),f=L.DomUtil.create("a",j,k);k.setAttribute("role","tab");k._sidebar=this;f.href="#"+b;f.id=b+"-toggle";f.title=h;L.DomEvent.on(f,"click",L.DomEvent.preventDefault);L.DomEvent.on(f,"click",this._onClick,k);k.sideClass=d;this._tabitems.push(k);var c=L.DomUtil.create("div","sidebar-pane",this._container),e=L.DomUtil.create("h1","sidebar-header",c);e.innerHTML=h;var a=L.DomUtil.create("div","sidebar-close",e);this._closeButtons.push(a);L.DomEvent.on(a,"click",this._onCloseClick,this);c.id=b;c.sideClass=d;c.appendChild(g);this._panes.push(c);return c},removeFrom:function(b){var a,c;this._map=null;for(a=this._tabitems.length-1;a>=0;a--){c=this._tabitems[a];L.DomEvent.off(c.querySelector("a"),"click",this._onClick)}for(a=this._closeButtons.length-1;a>=0;a--){c=this._closeButtons[a];L.DomEvent.off(c,"click",this._onCloseClick,this)}return this},open:function(c){var a,b;for(a=this._panes.length-1;a>=0;a--){b=this._panes[a];if(b.id===c){L.DomUtil.addClass(b,"active");if(b.sideClass){L.DomUtil.addClass(this._sidebar,b.sideClass)}}else{if(L.DomUtil.hasClass(b,"active")){L.DomUtil.removeClass(b,"active");if(b.sideClass){L.DomUtil.removeClass(this._sidebar,b.sideClass)}}}}for(a=this._tabitems.length-1;a>=0;a--){b=this._tabitems[a];if(b.querySelector("a").hash==="#"+c){L.DomUtil.addClass(b,"active")}else{if(L.DomUtil.hasClass(b,"active")){L.DomUtil.removeClass(b,"active")}}}this.fire("content",{id:c});if(L.DomUtil.hasClass(this._sidebar,"closed")){this.fire("opening");L.DomUtil.removeClass(this._sidebar,"closed")}return this},close:function(){for(var a=this._tabitems.length-1;a>=0;a--){var b=this._tabitems[a];if(L.DomUtil.hasClass(b,"active")){L.DomUtil.removeClass(b,"active");if(b.sideClass){L.DomUtil.removeClass(this._sidebar,b.sideClass)}}}if(!L.DomUtil.hasClass(this._sidebar,"closed")){this.fire("closing");L.DomUtil.addClass(this._sidebar,"closed")}return this},toggle:function(){this.close();if(L.DomUtil.hasClass(this._sidebar,"collapsed")){L.DomUtil.addClass(this._sidebar,"closed");this.fire("expanding");L.DomUtil.removeClass(this._sidebar,"collapsed");L.DomUtil.removeClass(this._toggleButton,"collapsed")}else{L.DomUtil.removeClass(this._sidebar,"closed");this.fire("collapsing");L.DomUtil.addClass(this._sidebar,"collapsed");L.DomUtil.addClass(this._toggleButton,"collapsed")}},_onClick:function(){if(L.DomUtil.hasClass(this,"active")){this._sidebar.close()}else{if(!L.DomUtil.hasClass(this,"disabled")){this._sidebar.open(this.querySelector("a").hash.slice(1))}}},_onCloseClick:function(){this.close()},_createButton:function(d,b,a){var c=L.DomUtil.create("a",b,a);c.href="#";c.title=d;L.DomEvent.addListener(c,"click",L.DomEvent.stopPropagation).addListener(c,"click",L.DomEvent.preventDefault).addListener(c,"click",this.toggle,this);return c}});L.control.sidebar=function(b,a){return new L.Control.Sidebar(b,a)};L.Control.WCS=L.Control.extend({options:{position:"bottomleft",title:"Center coordinates. Click to change",coordinates:[{label:"RA, Dec",units:"HMS",nativeCelsys:false}],centerQueryKey:"center",fovQueryKey:"fov"},onAdd:function(a){var f=this,g="leaflet-control-wcs",h=this._wcsdialog=L.DomUtil.create("div",g+"-dialog"),e=L.DomUtil.create("select",g+"-select",h),b=document.createElement("option"),l=this.options.coordinates,d=[],j;L.DomEvent.disableClickPropagation(e);this._currentCoord=0;e.id="leaflet-coord-select";e.title="Switch coordinate system";for(var i in l){d[i]=document.createElement("option");d[i].text=l[i].label;j=parseInt(i,10);d[i].value=j;if(j===0){d[i].selected=true}e.add(d[i],null)}L.DomEvent.on(e,"change",function(c){f._currentCoord=e.value;f._onDrag()});var k=this._wcsinput=L.DomUtil.create("input",g+"-input",h);L.DomEvent.disableClickPropagation(k);k.type="text";k.title=this.options.title;if("webkitSpeechRecognition" in window){k.setAttribute("x-webkit-speech","x-webkit-speech")}a.on("move zoomend",this._onDrag,this);L.DomEvent.on(k,"focus",function(){this.setSelectionRange(0,this.value.length)},k);L.DomEvent.on(k,"change",function(){this.panTo(this._wcsinput.value)},this);var m=L.DomUtil.create("div",g+"-clipboard",h);m.title="Copy to clipboard";L.DomEvent.on(m,"click",function(){var o={},n=location.href,c=this._map.options.crs,p=a.getCenter();L.IIPUtils.flashElement(this._wcsinput);n=L.IIPUtils.updateURL(n,this.options.centerQueryKey,this._latLngToHMSDMS(p));n=L.IIPUtils.updateURL(n,this.options.fovQueryKey,c.zoomToFov(a,a.getZoom(),p).toPrecision(4));history.pushState(o,"",n);L.IIPUtils.copyToClipboard(n)},this);return this._wcsdialog},onRemove:function(a){a.off("drag",this._onDrag)},_onDrag:function(b){var d=this._map.getCenter(),a=this._map.options.crs,c=this.options.coordinates[this._currentCoord];if(a.pixelFlag){this._wcsinput.value=d.lng.toFixed(0)+" , "+d.lat.toFixed(0)}else{if(!c.nativeCelsys&&a.forceNativeCelsys){d=a.celsysToEq(d)}else{if(c.nativeCelsys&&a.forceNativeCelsys===false){d=a.eqToCelsys(d)}}switch(c.units){case"HMS":this._wcsinput.value=this._latLngToHMSDMS(d);break;case"deg":this._wcsinput.value=d.lng.toFixed(5)+" , "+d.lat.toFixed(5);break;default:this._wcsinput.value=d.lng.toFixed(1)+" , "+d.lat.toFixed(1);break}}},_latLngToHMSDMS:function(a){var l=(a.lng+360)/360;l=(l-Math.floor(l))*24;var e=Math.floor(l),i=(l-e)*60,b=Math.floor(i),f=(i-b)*60;if(f>=60){b++;f=0}if(b===60){e++;b=0}var j=(e<10?"0":"")+e.toString()+":"+(b<10?"0":"")+b.toString()+":"+(f<10?"0":"")+f.toFixed(3),k=Math.abs(a.lat),c=a.lat<0?"-":"+",g=Math.floor(k);i=(k-g)*60;b=Math.floor(i);f=(i-b)*60;if(f>=60){b++;f=0}if(b===60){e++;b=0}return j+" "+c+(g<10?"0":"")+g.toString()+":"+(b<10?"0":"")+b.toString()+":"+(f<10?"0":"")+f.toFixed(2)},panTo:function(d){var c=/^(-?\d+\.?\d*)\s*,\s*\+?(-?\d+\.?\d*)/g,a=c.exec(d),b=this._map.options.crs,f=this.options.coordinates[this._currentCoord],e=b.parseCoords(d);if(e){if(b.pixelFlag){this._map.panTo(e)}else{if(!f.nativeCelsys&&b.forceNativeCelsys){e=b.eqToCelsys(e)}else{if(f.nativeCelsys&&b.forceNativeCelsys===false){e=b.celsysToEq(e)}}this._map.panTo(e)}}else{L.IIPUtils.requestURL("http://cdsweb.u-strasbg.fr/cgi-bin/nph-sesame/-oI/A?"+d,"getting coordinates for "+d,this._getCoordinates,this,10)}},_getCoordinates:function(d,a){if(a.readyState===4){if(a.status===200){var b=a.responseText,c=d._map.options.crs.parseCoords(b,true);if(c){d._map.panTo(c);d._onDrag()}else{alert(b+": Unknown location")}}else{alert("There was a problem with the request to the Sesame service at CDS")}}}});L.Map.mergeOptions({positionControl:false});L.Map.addInitHook(function(){if(this.options.positionControl){this.positionControl=new L.Control.MousePosition();this.addControl(this.positionControl)}});L.control.wcs=function(a){return new L.Control.WCS(a)};