version: '2'
services:

  backend:
    build: ./api
    volumes:
      - ./api:/app
      - ./archive:/archive
      - ./log:/log

    command: ./entrypoint.sh
    environment:
      - NCSA=true
    links:
        - rabbit
    depends_on:
        - rabbit      

  rabbit:
      hostname: rabbit
      image: rabbitmq:latest
      environment:
          - RABBITMQ_DEFAULT_USER=admin
          - RABBITMQ_DEFAULT_PASS=mypass
      ports:
          - "5673:5672"

  iipserver:
    image: linea/iipserver:latest
    environment:
      - LOGFILE=/tmp/iipsrv.log
      - VERBOSITY=10
      - FILESYSTEM_PREFIX=/images/
      - MAX_IMAGE_CACHE_SIZE=10
      - MAX_CVT=3000
      - JPEG_QUALITY=90
    command: ./start_fcgi.sh

  nginx:
    build: ./frontend
    ports:
      - 80:8080
    volumes:
      - ./frontend/nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontend/build/production:/var/www/frontend
      # - ./frontend/build:/var/www/frontend
      # - ./apps:/var/www/frontend/dri/apps
    depends_on:
      - backend
      - iipserver